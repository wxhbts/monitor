<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="https://cdn.cydiaa.com/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è…¾è®¯äº‘EdgeOne ç›‘æ§å¤§å±</title>
	<script>
        // ç«‹å³æ‰§è¡Œï¼Œæ£€æŸ¥æœ¬åœ°å­˜å‚¨æˆ–ç³»ç»Ÿåå¥½
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <!-- Tailwind CSS for Shadcn/UI style -->
    <script src="https://eo.cydiaa.com/?url=https://cdn.tailwindcss.com"></script>
    <script src="https://eo.cydiaa.com/?url=https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://eo.cydiaa.com/?url=https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/js/world.js"></script>
    <style>
        @import url('https://eo.cydiaa.com/?url=https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: {
                            DEFAULT: "hsl(var(--primary))",
                            foreground: "hsl(var(--primary-foreground))",
                        },
                        secondary: {
                            DEFAULT: "hsl(var(--secondary))",
                            foreground: "hsl(var(--secondary-foreground))",
                        },
                        destructive: {
                            DEFAULT: "hsl(var(--destructive))",
                            foreground: "hsl(var(--destructive-foreground))",
                        },
                        muted: {
                            DEFAULT: "hsl(var(--muted))",
                            foreground: "hsl(var(--muted-foreground))",
                        },
                        accent: {
                            DEFAULT: "hsl(var(--accent))",
                            foreground: "hsl(var(--accent-foreground))",
                        },
                        popover: {
                            DEFAULT: "hsl(var(--popover))",
                            foreground: "hsl(var(--popover-foreground))",
                        },
                        card: {
                            DEFAULT: "hsl(var(--card))",
                            foreground: "hsl(var(--card-foreground))",
                        },
                    },
                    borderRadius: {
                        lg: "var(--radius)",
                        md: "calc(var(--radius) - 2px)",
                        sm: "calc(var(--radius) - 4px)",
                    },
                },
            },
        }
    </script>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 222.2 84% 4.9%;
            --card: 0 0% 100%;
            --card-foreground: 222.2 84% 4.9%;
            --popover: 0 0% 100%;
            --popover-foreground: 222.2 84% 4.9%;
            --primary: 222.2 47.4% 11.2%;
            --primary-foreground: 210 40% 98%;
            --secondary: 210 40% 96.1%;
            --secondary-foreground: 222.2 47.4% 11.2%;
            --muted: 210 40% 96.1%;
            --muted-foreground: 215.4 16.3% 46.9%;
            --accent: 210 40% 96.1%;
            --accent-foreground: 222.2 47.4% 11.2%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 40% 98%;
            --border: 214.3 31.8% 91.4%;
            --input: 214.3 31.8% 91.4%;
            --ring: 222.2 84% 4.9%;
            --radius: 0.75rem;
        }

        /* ğŸŒ™ å¤œé—´æ¨¡å¼ */
        html.dark {
            --background: 240 10% 3.9%;
            --foreground: 0 0% 98%;
            --card: 240 10% 3.9%;
            --card-foreground: 0 0% 98%;
            --popover: 240 10% 3.9%;
            --popover-foreground: 0 0% 98%;
            --primary: 212 100% 68%;
            --primary-foreground: 0 0% 9%;
            --secondary: 240 3.7% 15.9%;
            --secondary-foreground: 0 0% 98%;
            --muted: 240 3.7% 15.9%;
            --muted-foreground: 0 0% 63.9%;
            --accent: 240 3.7% 15.9%;
            --accent-foreground: 0 0% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 0 0% 98%;
            --border: 240 3.7% 15.9%;
            --input: 240 3.7% 15.9%;
            --ring: 212 100% 68%;
            --radius: 0.75rem;
            *, ::after, ::before {
                border-color: hsl(var(--border));
            }
        }
    </style>
</head>
<body class="bg-background text-foreground min-h-screen p-8 transition-colors">
    <!-- Loading Progress Bar -->
    <div id="loading-progress-container" class="fixed top-0 left-0 w-full h-1 z-50 bg-transparent pointer-events-none">
        <div id="loading-progress-bar" class="h-full bg-blue-500 transition-all duration-300 ease-out w-0"></div>
    </div>
    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Header -->
        <div class="flex items-center justify-between">
            <div>
                <h1 id="page-header" class="text-3xl font-bold tracking-tight text-foreground">è…¾è®¯äº‘EdgeOne ç›‘æ§å¤§å±</h1>
                <p class="text-muted-foreground mt-1">è…¾è®¯äº‘EdgeOne ç«™ç‚¹æµé‡ä¸è¯·æ±‚é‡åˆ†æ</p>
            </div>
            <!-- ğŸŒ™ å¤œé—´æ¨¡å¼æŒ‰é’® -->
            <button
                id="themeToggle"
                onclick="toggleTheme()"
                class="h-9 px-4 rounded-md border bg-card text-card-foreground hover:bg-accent transition text-sm"
            >
                ğŸŒ™ å¤œé—´æ¨¡å¼
            </button>
        </div>

        <!-- Time Controls -->
        <div class="flex flex-wrap items-center gap-4 bg-card p-4 rounded-xl border border-border shadow-sm transition-colors">
            <div class="flex items-center space-x-2">
                <label for="timeRange" class="text-sm font-medium text-foreground">æ—¶é—´èŒƒå›´:</label>
                <select id="timeRange" onchange="handleTimeRangeChange()" class="h-9 w-[180px] rounded-md border border-border bg-background text-foreground px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    <option value="30min">è¿‘ 30 åˆ†é’Ÿ</option>
                    <option value="1h">è¿‘ 1 å°æ—¶</option>
                    <option value="6h">è¿‘ 6 å°æ—¶</option>
                    <option value="today">ä»Šæ—¥</option>
                    <option value="yesterday">æ˜¨æ—¥</option>
                    <option value="3d">è¿‘ 3 å¤©</option>
                    <option value="7d">è¿‘ 7 å¤©</option>
                    <option value="14d">è¿‘ 14 å¤©</option>
                    <option value="31d">è¿‘ 31 å¤©</option>
                    <option value="custom">è‡ªå®šä¹‰</option>
                </select>
            </div>
            <!-- Custom Time Inputs -->
            <div id="customTimeInputs" class="hidden flex-wrap items-center gap-2 mt-2 w-full sm:w-auto">
                <div class="flex items-center space-x-1">
                    <input type="number" id="customDays" placeholder="0" class="h-8 w-16 rounded-md border border-border bg-background text-foreground px-2 text-sm" min="0" max="31">
                    <span class="text-xs">å¤©</span>
                </div>
                <div class="flex items-center space-x-1">
                    <input type="number" id="customHours" placeholder="0" class="h-8 w-16 rounded-md border border-border bg-background text-foreground px-2 text-sm" min="0" max="23">
                    <span class="text-xs">å°æ—¶</span>
                </div>
                <div class="flex items-center space-x-1">
                    <input type="number" id="customMinutes" placeholder="0" class="h-8 w-16 rounded-md border border-border bg-background text-foreground px-2 text-sm" min="0" max="59">
                    <span class="text-xs">åˆ†</span>
                </div>
                <div class="flex items-center space-x-1">
                    <input type="number" id="customSeconds" placeholder="0" class="h-8 w-16 rounded-md border border-border bg-background text-foreground px-2 text-sm" min="0" max="59">
                    <span class="text-xs">ç§’</span>
                </div>
                <button onclick="refreshData()" class="h-8 px-3 bg-primary text-primary-foreground rounded-md text-xs hover:bg-primary/90">åº”ç”¨</button>
                <span id="timeRangeError" class="text-red-500 text-xs font-medium ml-2"></span>
            </div>
            <div class="flex items-center space-x-2">
                <label for="interval" class="text-sm font-medium text-foreground">ç²’åº¦:</label>
                <select id="interval" onchange="refreshData()" class="h-9 w-[180px] rounded-md border border-border bg-background text-foreground px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                    <option value="auto" selected>è‡ªåŠ¨</option>
                    <option value="min">1 åˆ†é’Ÿ</option>
                    <option value="5min">5 åˆ†é’Ÿ</option>
                    <option value="hour">1 å°æ—¶</option>
                    <option value="day">1 å¤©</option>
                </select>
            </div>
             
           <div class="flex items-center space-x-2">
            <label for="cdnSelector" class="text-sm font-medium text-foreground">CDNæœåŠ¡å•†:</label>
            <select id="cdnSelector" onchange="if(this.value) window.location.href=this.value" class="h-9 w-[240px] rounded-md border border-border bg-background text-foreground px-3 py-1 text-sm shadow-sm transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring">
                <option value="" selected >è…¾è®¯äº‘ EO ç›‘æ§</option>
                <option value="aliesa.html" >é˜¿é‡Œäº‘ ESA ç›‘æ§</option>
                <option value="cloudflare.html">Cloudflare ç›‘æ§</option>
                </select>
            </div>
        </div>

        <!-- Main Content -->
        <div class="space-y-8">

            <!-- Section 1: Traffic (æµé‡) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-foreground flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    æµé‡åˆ†æ (Traffic)
                </h2>
                <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-3">
                    <!-- Total Traffic Card -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">æ€»æµé‡ (Total)</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_flux">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">è®¿é—®æ€»æµé‡</p>
                        </div>
                    </div>
                    <!-- Client Request Traffic -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">å®¢æˆ·ç«¯è¯·æ±‚æµé‡ (In)</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_inFlux">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">å®¢æˆ·ç«¯è¯·æ±‚æµé‡</p>
                        </div>
                    </div>
                    <!-- EdgeOne Response Traffic -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">å“åº”æµé‡ (Out)</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_outFlux">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">EdgeOne å“åº”æµé‡</p>
                        </div>
                    </div>
                </div>
                <!-- Traffic Chart -->
                <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                    <div class="flex flex-col space-y-1.5 p-6">
                        <h3 class="font-semibold leading-none tracking-tight">æµé‡è¶‹åŠ¿</h3>
                    </div>
                    <div class="p-6 pt-0">
                        <div id="chart_traffic" class="w-full h-[350px]"></div>
                    </div>
                </div>
            </div>

            <!-- Section 2: Bandwidth (å¸¦å®½) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-foreground flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    å¸¦å®½åˆ†æ (Bandwidth)
                </h2>
                <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-3">
                    <!-- Total Bandwidth -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">æ€»å¸¦å®½å³°å€¼ (Total)</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_bandwidth">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">è®¿é—®æ€»å¸¦å®½å³°å€¼</p>
                        </div>
                    </div>
                    <!-- In Bandwidth -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">è¯·æ±‚å¸¦å®½å³°å€¼ (In)</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_inBandwidth">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">å®¢æˆ·ç«¯è¯·æ±‚å¸¦å®½å³°å€¼</p>
                        </div>
                    </div>
                    <!-- Out Bandwidth -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">å“åº”å¸¦å®½å³°å€¼ (Out)</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_outBandwidth">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">EdgeOne å“åº”å¸¦å®½å³°å€¼</p>
                        </div>
                    </div>
                </div>
                <!-- Bandwidth Chart -->
                <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                    <div class="flex flex-col space-y-1.5 p-6">
                        <h3 class="font-semibold leading-none tracking-tight">å¸¦å®½è¶‹åŠ¿</h3>
                    </div>
                    <div class="p-6 pt-0">
                        <div id="chart_bandwidth" class="w-full h-[350px]"></div>
                    </div>
                </div>
            </div>

            <!-- Section 3: Origin Pull Analysis (å›æºåˆ†æ) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-foreground flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                    å›æºåˆ†æ (Origin Pull Analysis)
                </h2>
                <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-3">
                    <!-- Origin Out Flux -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">å›æºè¯·æ±‚æµé‡</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_outFlux_hy">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">EdgeOne èŠ‚ç‚¹è‡³æºç«™</p>
                        </div>
                    </div>
                    <!-- Origin Requests -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">å›æºè¯·æ±‚æ•°</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_request_hy">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">EdgeOne èŠ‚ç‚¹è‡³æºç«™</p>
                        </div>
                    </div>
                    <!-- Origin Out Bandwidth -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">å›æºè¯·æ±‚å¸¦å®½å³°å€¼</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_outBandwidth_hy">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">EdgeOne èŠ‚ç‚¹è‡³æºç«™</p>
                        </div>
                    </div>
                </div>
                <!-- Origin Bandwidth Cards -->
                <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-3">
                    <!-- Origin In Flux -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">å›æºå“åº”æµé‡</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_inFlux_hy">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">æºç«™è‡³ EdgeOne èŠ‚ç‚¹</p>
                        </div>
                    </div>
                    <!-- Origin In Bandwidth -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">å›æºå“åº”å¸¦å®½å³°å€¼</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_inBandwidth_hy">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">æºç«™è‡³ EdgeOne èŠ‚ç‚¹</p>
                        </div>
                    </div>
                    <!-- Cache Hit Rate -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">ç¼“å­˜å‘½ä¸­ç‡</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_cache_hit_rate">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">æºç«™å“åº” / EdgeOne å“åº”</p>
                        </div>
                    </div>
                </div>
                
                <!-- Origin Pull Chart -->
                <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                    <div class="flex flex-col space-y-1.5 p-6">
                        <h3 class="font-semibold leading-none tracking-tight">å›æºè¶‹åŠ¿</h3>
                    </div>
                    <div class="p-6 pt-0">
                        <div id="chart_origin_pull" class="w-full h-[350px]"></div>
                    </div>
                </div>
            </div>

            <!-- Section: Edge Functions (è¾¹ç¼˜å‡½æ•°) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-foreground flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                    è¾¹ç¼˜å‡½æ•° (Edge Functions)
                </h2>
                <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-2">
                    <!-- Function Requests -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">æ€»è¯·æ±‚æ•°</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_function_requestCount">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">Edge Functions æ€»è°ƒç”¨æ¬¡æ•°</p>
                        </div>
                    </div>
                    <!-- Function CPU Time -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">æ€» CPU æ—¶é—´</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_function_cpuCostTime">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">Edge Functions æ€» CPU è€—æ—¶ (ms)</p>
                        </div>
                    </div>
                </div>
                <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-2">
                    <!-- Function Requests Chart -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å‡½æ•°è¯·æ±‚æ•°è¶‹åŠ¿</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_function_requests" class="w-full h-[350px]"></div>
                        </div>
                    </div>
                    <!-- Function CPU Chart -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å‡½æ•° CPU è€—æ—¶è¶‹åŠ¿</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_function_cpu" class="w-full h-[350px]"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section: Pages Build Statistics (Pages ç»Ÿè®¡) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-foreground flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                    Pages ç»Ÿè®¡ (Pages Stats)
                </h2>
                <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                    <!-- Daily Build Count -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">å½“æ—¥æ„å»ºæ¬¡æ•°</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_pages_daily_build">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">Pages å½“æ—¥æ„å»ºæ€»æ¬¡æ•°</p>
                        </div>
                    </div>
                    <!-- Monthly Build Count -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">å½“æœˆæ„å»ºæ¬¡æ•°</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_pages_monthly_build">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">Pages å½“æœˆæ„å»ºæ€»æ¬¡æ•°</p>
                        </div>
                    </div>
                    <!-- Cloud Functions 24h Requests -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">Cloud Functions 24h è¯·æ±‚æ•°</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_pages_cloud_function_total">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">Cloud Functions 24h æ€»è¯·æ±‚æ•°</p>
                        </div>
                    </div>
					</div>
					<div class="grid gap-4 md:grid-cols-2 lg:grid-cols-2">
                    <!-- Cloud Functions Monthly Requests -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">å½“æœˆ Cloud Functions è¯·æ±‚æ•°</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_pages_monthly_cf_requests">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">æœ¬æœˆç´¯è®¡è¯·æ±‚æ•°</p>
                        </div>
                    </div>
                     <!-- Cloud Functions Monthly GBs -->
                     <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">å½“æœˆ Cloud Functions GBs</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_pages_monthly_cf_gbs">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">æœ¬æœˆç´¯è®¡èµ„æºä½¿ç”¨é‡ (GBs)</p>
                        </div>
                    </div>
                </div>
                <!-- Cloud Function Request Chart -->
                <div class="grid gap-4 md:grid-cols-1 lg:grid-cols-1">
                     <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">Cloud Functions è¯·æ±‚æ•°è¶‹åŠ¿</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_pages_cloud_function_requests" class="w-full h-[350px]"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 4: Requests & Performance (è¯·æ±‚ä¸æ€§èƒ½) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-foreground flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    è¯·æ±‚ä¸æ€§èƒ½ (Requests & Performance)
                </h2>
                <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-3">
                    <!-- Total Requests -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">æ€»è¯·æ±‚æ•°</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_request">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">æ€»è¯·æ±‚æ¬¡æ•°</p>
                        </div>
                    </div>
                    <!-- Avg Response Time -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">å¹³å‡å“åº”è€—æ—¶</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_avgResponseTime">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">L7 è®¿é—®å¹³å‡å“åº”è€—æ—¶ (ms)</p>
                        </div>
                    </div>
                    <!-- Avg First Byte Time -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">å¹³å‡é¦–å­—èŠ‚è€—æ—¶</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_avgFirstByteResponseTime">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">L7 è®¿é—®å¹³å‡é¦–å­—èŠ‚å“åº”è€—æ—¶ (ms)</p>
                        </div>
                    </div>
                </div>
                <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-2">
                    <!-- Requests Chart -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">è¯·æ±‚æ•°è¶‹åŠ¿</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_requests" class="w-full h-[350px]"></div>
                        </div>
                    </div>
                    <!-- Performance Chart -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å“åº”è€—æ—¶è¶‹åŠ¿</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_performance" class="w-full h-[350px]"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Section 5: Security Analysis (å®‰å…¨åˆ†æ) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-foreground flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                    å®‰å…¨åˆ†æ (Security Analysis)
                </h2>
                <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-1">
                    <!-- Total Protection Hits -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">æ€»é˜²æŠ¤å‘½ä¸­æ¬¡æ•°</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_security_hits">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">DDoS/CC é˜²æŠ¤æ€»æ‹¦æˆªæ¬¡æ•°</p>
                        </div>
                    </div>
                </div>
                <!-- Security Chart -->
                <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                    <div class="flex flex-col space-y-1.5 p-6">
                        <h3 class="font-semibold leading-none tracking-tight">å®‰å…¨é˜²æŠ¤è¶‹åŠ¿</h3>
                    </div>
                    <div class="p-6 pt-0">
                        <div id="chart_security" class="w-full h-[350px]"></div>
                    </div>
                </div>
            </div>

            <!-- Section 6: Top Analysis (TOP åˆ†æ) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-foreground flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    TOP åˆ†æ (Top Analysis)
                </h2>
                <!-- World Map -->
                <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                    <div class="flex flex-col space-y-1.5 p-6">
                        <h3 class="font-semibold leading-none tracking-tight">å…¨çƒè¯·æ±‚åˆ†å¸ƒ</h3>
                    </div>
                    <div class="p-6 pt-0">
                        <div id="chart_top_map" class="w-full h-[500px]"></div>
                    </div>
                </div>
                <div class="grid gap-4 md:grid-cols-2">
                    <!-- Country -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å›½å®¶/åœ°åŒºæµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_country" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å›½å®¶/åœ°åŒºè¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_country" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Province -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å›½å†…çœä»½æµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_province" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å›½å†…çœä»½è¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_province" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Status Code -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">çŠ¶æ€ç æµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_status_code" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">çŠ¶æ€ç è¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_status_code" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Domain -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">åŸŸåæµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_domain" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">åŸŸåè¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_domain" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- URL -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">URL æµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_url" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">URL è¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_url" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Resource Type -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">èµ„æºç±»å‹æµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_resource_type" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">èµ„æºç±»å‹è¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_resource_type" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Client IP -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å®¢æˆ·ç«¯IPæµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_sip" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å®¢æˆ·ç«¯IPè¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_sip" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Referer -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">Referer æµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_referer" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">Referer è¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_referer" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Device Type -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">è®¾å¤‡ç±»å‹æµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_ua_device" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">è®¾å¤‡ç±»å‹è¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_ua_device" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- Browser -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">æµè§ˆå™¨æµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_ua_browser" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">æµè§ˆå™¨è¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_ua_browser" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- OS -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">æ“ä½œç³»ç»Ÿæµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_ua_os" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">æ“ä½œç³»ç»Ÿè¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_ua_os" class="w-full h-[500px]"></div>
                        </div>
                    </div>

                    <!-- User Agent -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">User Agent æµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_ua" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">User Agent è¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_ua" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

    </div>

    <script>
        // ECharts instance variables
        let chartTraffic = null;
        let chartBandwidth = null;
        let chartRequests = null;
        let chartPerformance = null;
        let chartSecurity = null;
        let chartOriginPull = null;
        let chartTopCountry = null;
        let chartTopProvince = null;
        let chartTopStatusCode = null;
        let chartTopDomain = null;
        let chartTopUrl = null;
        let chartTopResourceType = null;
        let chartTopSip = null;
        let chartTopReferer = null;
        let chartTopUaDevice = null;
        let chartTopUaBrowser = null;
        let chartTopUaOs = null;
        let chartTopUa = null;
        let chartTopRequestCountry = null;
        let chartTopRequestProvince = null;
        let chartTopRequestStatusCode = null;
        let chartTopRequestDomain = null;
        let chartTopRequestUrl = null;
        let chartTopRequestResourceType = null;
        let chartTopRequestSip = null;
        let chartTopRequestReferer = null;
        let chartTopRequestUaDevice = null;
        let chartTopRequestUaBrowser = null;
        let chartTopRequestUaOs = null;
        let chartTopRequestUa = null;
        let chartTopMap = null;
        let chartFunctionRequests = null;
        let chartFunctionCpu = null;
        let chartPagesCloudFunctionRequests = null;

        let lastResults = null; // Global variable to store last fetched data for theme switching

        const provinceMap = {
            '22': 'åŒ—äº¬', '86': 'å†…è’™å¤', '146': 'å±±è¥¿', '1069': 'æ²³åŒ—', '1177': 'å¤©æ´¥',
            '119': 'å®å¤', '152': 'é™•è¥¿', '1208': 'ç”˜è‚ƒ', '1467': 'é’æµ·', '1468': 'æ–°ç–†',
            '145': 'é»‘é¾™æ±Ÿ', '1445': 'å‰æ—', '1464': 'è¾½å®', '2': 'ç¦å»º', '120': 'æ±Ÿè‹',
            '121': 'å®‰å¾½', '122': 'å±±ä¸œ', '1050': 'ä¸Šæµ·', '1442': 'æµ™æ±Ÿ', '182': 'æ²³å—',
            '1135': 'æ¹–åŒ—', '1465': 'æ±Ÿè¥¿', '1466': 'æ¹–å—', '118': 'è´µå·', '153': 'äº‘å—',
            '1051': 'é‡åº†', '1068': 'å››å·', '1155': 'è¥¿è—', '4': 'å¹¿ä¸œ', '173': 'å¹¿è¥¿',
            '1441': 'æµ·å—', '0': 'å…¶ä»–', '1': 'æ¸¯æ¾³å°', '-1': 'å¢ƒå¤–'
        };

        const countryMap = {
            'CN': 'ä¸­å›½å¤§é™†', 'AF': 'é˜¿å¯Œæ±—', 'MV': 'é©¬å°”ä»£å¤«', 'AM': 'äºšç¾å°¼äºš', 'MN': 'è’™å¤', 'AZ': 'é˜¿å¡æ‹œç–†',
            'MM': 'ç¼…ç”¸', 'BH': 'å·´æ—', 'NP': 'å°¼æ³Šå°”', 'BD': 'å­ŸåŠ æ‹‰', 'KP': 'æœé²œ',
            'BT': 'ä¸ä¸¹', 'OM': 'é˜¿æ›¼', 'IO': 'è‹±å±å°åº¦æ´‹é¢†åœ°', 'PK': 'å·´åŸºæ–¯å¦', 'KH': 'æŸ¬åŸ”å¯¨',
            'PS': 'å·´å‹’æ–¯å¦', 'CX': 'åœ£è¯å²›', 'PH': 'è²å¾‹å®¾', 'HK': 'ä¸­å›½é¦™æ¸¯', 'QA': 'å¡å¡”å°”',
            'IN': 'å°åº¦', 'SA': 'æ²™ç‰¹é˜¿æ‹‰ä¼¯', 'ID': 'å°åº¦å°¼è¥¿äºš', 'SG': 'æ–°åŠ å¡', 'IR': 'ä¼Šæœ—',
            'KR': 'éŸ©å›½', 'IQ': 'ä¼Šæ‹‰å…‹', 'LK': 'æ–¯é‡Œå…°å¡', 'IL': 'ä»¥è‰²åˆ—', 'SY': 'å™åˆ©äºš',
            'JP': 'æ—¥æœ¬', 'TW': 'ä¸­å›½å°æ¹¾', 'JO': 'çº¦æ—¦', 'TJ': 'å¡”å‰å…‹æ–¯å¦', 'KZ': 'å“ˆè¨å…‹æ–¯å¦',
            'TH': 'æ³°å›½', 'KW': 'ç§‘å¨ç‰¹', 'TM': 'åœŸåº“æ›¼æ–¯å¦', 'KG': 'å‰å°”å‰æ–¯æ–¯å¦', 'AE': 'é˜¿è”é…‹',
            'LA': 'è€æŒ', 'UZ': 'ä¹Œå…¹åˆ«å…‹æ–¯å¦', 'LB': 'é»å·´å«©', 'VN': 'è¶Šå—', 'MO': 'ä¸­å›½æ¾³é—¨',
            'YE': 'ä¹Ÿé—¨', 'MY': 'é©¬æ¥è¥¿äºš', 'TR': 'åœŸè€³å…¶', 'AX': 'å¥¥å…°ç¾¤å²›', 'IT': 'æ„å¤§åˆ©',
            'AL': 'é˜¿å°”å·´å°¼äºš', 'JE': 'æ³½è¥¿å²›', 'AD': 'å®‰é“å°”', 'LT': 'ç«‹é™¶å®›', 'AT': 'å¥¥åœ°åˆ©',
            'LU': 'å¢æ£®å ¡', 'BY': 'ç™½ä¿„ç½—æ–¯', 'MK': 'é©¬å…¶é¡¿', 'BE': 'æ¯”åˆ©æ—¶', 'MT': 'é©¬è€³ä»–',
            'BA': 'æ³¢é»‘', 'MD': 'æ‘©å°”å¤šç“¦', 'BG': 'ä¿åŠ åˆ©äºš', 'MC': 'æ‘©çº³å“¥', 'BQ': 'è·å…°åŠ å‹’æ¯”åŒº',
            'ME': 'é»‘å±±', 'HR': 'å…‹ç½—åœ°äºš', 'NL': 'è·å…°', 'CZ': 'æ·å…‹', 'NO': 'æŒªå¨',
            'DK': 'ä¸¹éº¦', 'PL': 'æ³¢å…°', 'EE': 'çˆ±æ²™å°¼äºš', 'PT': 'è‘¡è„ç‰™', 'FO': 'æ³•ç½—ç¾¤å²›',
            'RO': 'ç½—é©¬å°¼äºš', 'FI': 'èŠ¬å…°', 'RU': 'ä¿„ç½—æ–¯', 'FR': 'æ³•å›½', 'SM': 'åœ£é©¬åŠ›è¯º',
            'DE': 'å¾·å›½', 'RS': 'å¡å°”ç»´äºš', 'GI': 'ç›´å¸ƒç½—é™€', 'SX': 'è·å±åœ£é©¬ä¸', 'GR': 'å¸Œè…Š',
            'SK': 'æ–¯æ´›ä¼å…‹', 'GG': 'æ ¹è¥¿å²›', 'ES': 'è¥¿ç­ç‰™', 'HU': 'åŒˆç‰™åˆ©', 'SE': 'ç‘å…¸',
            'IS': 'å†°å²›', 'CH': 'ç‘å£«', 'IE': 'çˆ±å°”å…°', 'UA': 'ä¹Œå…‹å…°', 'IM': 'é©¬æ©å²›',
            'GB': 'è‹±å›½', 'DZ': 'é˜¿å°”åŠåˆ©äºš', 'ML': 'é©¬é‡Œ', 'AO': 'å®‰å“¥æ‹‰', 'MR': 'æ¯›é‡Œå¡”å°¼äºš',
            'BJ': 'è´å®', 'MU': 'æ¯›é‡Œæ±‚æ–¯', 'BW': 'åšèŒ¨ç“¦çº³', 'YT': 'é©¬çº¦ç‰¹', 'BF': 'å¸ƒåŸºçº³æ³•ç´¢',
            'MA': 'æ‘©æ´›å“¥', 'BI': 'å¸ƒéš†è¿ª', 'MZ': 'è«æ¡‘æ¯”å…‹', 'CM': 'å–€éº¦éš†', 'NA': 'çº³ç±³æ¯”äºš',
            'CV': 'ä½›å¾—è§’', 'NE': 'å°¼æ—¥å°”', 'CF': 'ä¸­é', 'NG': 'å°¼æ—¥åˆ©äºš', 'TD': 'ä¹å¾—',
            'RW': 'å¢æ—ºè¾¾', 'KM': 'ç§‘æ‘©ç½—', 'SH': 'åœ£èµ«å‹’æ‹¿', 'DJ': 'å‰å¸ƒæ', 'ST': 'åœ£å¤šç¾å’Œæ™®æ—è¥¿æ¯”',
            'EG': 'åŸƒåŠ', 'SN': 'å¡å†…åŠ å°”', 'GQ': 'èµ¤é“å‡ å†…äºš', 'SC': 'å¡èˆŒå°”', 'ER': 'å„ç«‹ç‰¹é‡Œäºš',
            'SL': 'å¡æ‹‰åˆ©æ˜‚', 'ET': 'åŸƒå¡ä¿„æ¯”äºš', 'SO': 'ç´¢é©¬é‡Œ', 'GA': 'åŠ è“¬', 'ZA': 'å—é',
            'GM': 'å†ˆæ¯”äºš', 'SS': 'å—è‹ä¸¹', 'GH': 'åŠ çº³', 'SD': 'è‹ä¸¹', 'GN': 'å‡ å†…äºš',
            'SZ': 'æ–¯å¨å£«å…°', 'GW': 'å‡ å†…äºšæ¯”ç»', 'TZ': 'å¦æ¡‘å°¼äºš', 'KE': 'è‚¯å°¼äºš', 'TG': 'å¤šå“¥',
            'LS': 'è±ç´¢æ‰˜', 'TN': 'çªå°¼æ–¯', 'LR': 'åˆ©æ¯”é‡Œäºš', 'UG': 'ä¹Œå¹²è¾¾', 'LY': 'åˆ©æ¯”äºš',
            'EH': 'è¥¿æ’’å“ˆæ‹‰', 'MG': 'é©¬è¾¾åŠ æ–¯åŠ ', 'ZM': 'èµæ¯”äºš', 'MW': 'é©¬æ‹‰ç»´', 'ZW': 'æ´¥å·´å¸ƒéŸ¦',
            'CD': 'åˆšæœæ°‘ä¸»å…±å’Œå›½', 'CG': 'åˆšæœå…±å’Œå›½', 'CI': 'ç§‘ç‰¹è¿ªç“¦', 'AU': 'æ¾³å¤§åˆ©äºš', 'NF': 'è¯ºç¦å…‹å²›',
            'CK': 'åº“å…‹ç¾¤å²›', 'MP': 'åŒ—é©¬é‡Œäºšçº³ç¾¤å²›', 'TL': 'ä¸œå¸æ±¶', 'PW': 'å¸•åŠ³', 'GU': 'å…³å²›',
            'PG': 'å·´å¸ƒäºšæ–°å‡ å†…äºš', 'KI': 'åŸºé‡Œå·´æ–¯', 'SB': 'æ‰€ç½—é—¨ç¾¤å²›', 'MH': 'é©¬ç»å°”ç¾¤å²›', 'TO': 'æ±¤åŠ ',
            'NR': 'ç‘™é²', 'TV': 'å›¾ç“¦å¢', 'NZ': 'æ–°è¥¿å…°', 'AI': 'å®‰åœ­æ‹‰', 'HT': 'æµ·åœ°',
            'AG': 'å®‰æç“œå’Œå·´å¸ƒè¾¾', 'HN': 'æ´ªéƒ½æ‹‰æ–¯', 'AW': 'é˜¿é²å·´', 'JM': 'ç‰™ä¹°åŠ ', 'BS': 'å·´å“ˆé©¬',
            'MX': 'å¢¨è¥¿å“¥', 'BB': 'å·´å·´å¤šæ–¯', 'MS': 'è’™å¡æ‹‰ç‰¹å²›', 'BM': 'ç™¾æ…•å¤§', 'NI': 'å°¼åŠ æ‹‰ç“œ',
            'CA': 'åŠ æ‹¿å¤§', 'PA': 'å·´æ‹¿é©¬', 'KY': 'å¼€æ›¼ç¾¤å²›', 'PR': 'æ³¢å¤šé»å„', 'CR': 'å“¥æ–¯è¾¾é»åŠ ',
            'KN': 'åœ£åŸºèŒ¨å’Œå°¼ç»´æ–¯', 'CU': 'å¤å·´', 'LC': 'åœ£å¢è¥¿äºš', 'CW': 'åº“æ‹‰ç´¢', 'MF': 'æ³•å±åœ£é©¬ä¸',
            'SV': 'è¨å°”ç“¦å¤š', 'TT': 'ç‰¹ç«‹å°¼è¾¾å’Œå¤šå·´å“¥', 'GL': 'æ ¼é™µå…°å²›', 'TC': 'ç‰¹å…‹æ–¯å’Œå‡¯ç§‘æ–¯ç¾¤å²›',
            'GD': 'æ ¼æ—çº³è¾¾', 'US': 'ç¾å›½', 'GT': 'å±åœ°é©¬æ‹‰', 'AR': 'é˜¿æ ¹å»·', 'GY': 'åœ­äºšé‚£',
            'BO': 'ç»åˆ©ç»´äºš', 'PY': 'å·´æ‹‰åœ­', 'BR': 'å·´è¥¿', 'PE': 'ç§˜é²', 'CL': 'æ™ºåˆ©',
            'SR': 'è‹é‡Œå—', 'CO': 'å“¥ä¼¦æ¯”äºš', 'UY': 'ä¹Œæ‹‰åœ­', 'EC': 'å„ç“œå¤šå°”', 'VE': 'å§”å†…ç‘æ‹‰',
            'GF': 'æ³•å±åœ­äºšé‚£', 'Antarctica': 'å—ææ´²'
        };

        const codeToMapName = {
            'CN': 'China', 'AF': 'Afghanistan', 'AL': 'Albania', 'DZ': 'Algeria', 'AO': 'Angola', 'AR': 'Argentina',
            'AM': 'Armenia', 'AU': 'Australia', 'AT': 'Austria', 'AZ': 'Azerbaijan', 'BS': 'Bahamas', 'BH': 'Bahrain',
            'BD': 'Bangladesh', 'BB': 'Barbados', 'BY': 'Belarus', 'BE': 'Belgium', 'BZ': 'Belize', 'BJ': 'Benin',
            'BT': 'Bhutan', 'BO': 'Bolivia', 'BA': 'Bosnia and Herzegovina', 'BW': 'Botswana', 'BR': 'Brazil',
            'BN': 'Brunei', 'BG': 'Bulgaria', 'BF': 'Burkina Faso', 'BI': 'Burundi', 'KH': 'Cambodia', 'CM': 'Cameroon',
            'CA': 'Canada', 'CF': 'Central African Republic', 'TD': 'Chad', 'CL': 'Chile', 'CO': 'Colombia',
            'KM': 'Comoros', 'CG': 'Republic of the Congo', 'CD': 'Democratic Republic of the Congo', 'CR': 'Costa Rica',
            'HR': 'Croatia', 'CU': 'Cuba', 'CY': 'Cyprus', 'CZ': 'Czech Republic', 'DK': 'Denmark', 'DJ': 'Djibouti',
            'DO': 'Dominican Republic', 'EC': 'Ecuador', 'EG': 'Egypt', 'SV': 'El Salvador', 'GQ': 'Equatorial Guinea',
            'ER': 'Eritrea', 'EE': 'Estonia', 'ET': 'Ethiopia', 'FJ': 'Fiji', 'FI': 'Finland', 'FR': 'France',
            'GA': 'Gabon', 'GM': 'Gambia', 'GE': 'Georgia', 'DE': 'Germany', 'GH': 'Ghana', 'GR': 'Greece',
            'GT': 'Guatemala', 'GN': 'Guinea', 'GW': 'Guinea-Bissau', 'GY': 'Guyana', 'HT': 'Haiti', 'HN': 'Honduras',
            'HU': 'Hungary', 'IS': 'Iceland', 'IN': 'India', 'ID': 'Indonesia', 'IR': 'Iran', 'IQ': 'Iraq',
            'IE': 'Ireland', 'IL': 'Israel', 'IT': 'Italy', 'CI': 'Ivory Coast', 'JM': 'Jamaica', 'JP': 'Japan',
            'JO': 'Jordan', 'KZ': 'Kazakhstan', 'KE': 'Kenya', 'KP': 'North Korea', 'KR': 'South Korea',
            'KW': 'Kuwait', 'KG': 'Kyrgyzstan', 'LA': 'Laos', 'LV': 'Latvia', 'LB': 'Lebanon', 'LS': 'Lesotho',
            'LR': 'Liberia', 'LY': 'Libya', 'LT': 'Lithuania', 'LU': 'Luxembourg', 'MK': 'Macedonia', 'MG': 'Madagascar',
            'MW': 'Malawi', 'MY': 'Malaysia', 'ML': 'Mali', 'MT': 'Malta', 'MR': 'Mauritania', 'MU': 'Mauritius',
            'MX': 'Mexico', 'MD': 'Moldova', 'MN': 'Mongolia', 'ME': 'Montenegro', 'MA': 'Morocco', 'MZ': 'Mozambique',
            'MM': 'Myanmar', 'NA': 'Namibia', 'NP': 'Nepal', 'NL': 'Netherlands', 'NZ': 'New Zealand', 'NI': 'Nicaragua',
            'NE': 'Niger', 'NG': 'Nigeria', 'NO': 'Norway', 'OM': 'Oman', 'PK': 'Pakistan', 'PA': 'Panama',
            'PG': 'Papua New Guinea', 'PY': 'Paraguay', 'PE': 'Peru', 'PH': 'Philippines', 'PL': 'Poland',
            'PT': 'Portugal', 'PR': 'Puerto Rico', 'QA': 'Qatar', 'RO': 'Romania', 'RU': 'Russia', 'RW': 'Rwanda',
            'SA': 'Saudi Arabia', 'SN': 'Senegal', 'RS': 'Serbia', 'SL': 'Sierra Leone', 'SG': 'Singapore',
            'SK': 'Slovakia', 'SI': 'Slovenia', 'SB': 'Solomon Islands', 'SO': 'Somalia', 'ZA': 'South Africa',
            'SS': 'South Sudan', 'ES': 'Spain', 'LK': 'Sri Lanka', 'SD': 'Sudan', 'SR': 'Suriname', 'SZ': 'Swaziland',
            'SE': 'Sweden', 'CH': 'Switzerland', 'SY': 'Syria', 'TW': 'Taiwan', 'TJ': 'Tajikistan', 'TZ': 'Tanzania',
            'TH': 'Thailand', 'TL': 'Timor-Leste', 'TG': 'Togo', 'TT': 'Trinidad and Tobago', 'TN': 'Tunisia',
            'TR': 'Turkey', 'TM': 'Turkmenistan', 'UG': 'Uganda', 'UA': 'Ukraine', 'AE': 'United Arab Emirates',
            'GB': 'United Kingdom', 'US': 'United States', 'UY': 'Uruguay', 'UZ': 'Uzbekistan', 'VU': 'Vanuatu',
            'VE': 'Venezuela', 'VN': 'Vietnam', 'GL': 'Greenland','YE': 'Yemen', 'ZM': 'Zambia', 'ZW': 'Zimbabwe'
        };

        const worldNameMap = {};
        Object.keys(codeToMapName).forEach(code => {
            if (countryMap[code]) {
                worldNameMap[codeToMapName[code]] = countryMap[code];
            }
        });

        const metricsConfig = {
            traffic: ['l7Flow_flux', 'l7Flow_inFlux', 'l7Flow_outFlux'],
            bandwidth: ['l7Flow_bandwidth', 'l7Flow_inBandwidth', 'l7Flow_outBandwidth'],
            originPull: ['l7Flow_outFlux_hy', 'l7Flow_inFlux_hy', 'l7Flow_outBandwidth_hy', 'l7Flow_inBandwidth_hy', 'l7Flow_request_hy'],
            requests: ['l7Flow_request'],
            performance: ['l7Flow_avgResponseTime', 'l7Flow_avgFirstByteResponseTime'],
            edgeFunctions: ['function_requestCount', 'function_cpuCostTime'],
            security: ['ccAcl_interceptNum', 'ccManage_interceptNum', 'ccRate_interceptNum'],
            topAnalysis: ['l7Flow_outFlux_country', 'l7Flow_outFlux_province', 'l7Flow_outFlux_statusCode', 'l7Flow_outFlux_domain', 'l7Flow_outFlux_url', 'l7Flow_outFlux_resourceType', 'l7Flow_outFlux_sip', 'l7Flow_outFlux_referers', 'l7Flow_outFlux_ua_device', 'l7Flow_outFlux_ua_browser', 'l7Flow_outFlux_ua_os', 'l7Flow_outFlux_ua', 'l7Flow_request_country', 'l7Flow_request_province', 'l7Flow_request_statusCode', 'l7Flow_request_domain', 'l7Flow_request_url', 'l7Flow_request_resourceType', 'l7Flow_request_sip', 'l7Flow_request_referers', 'l7Flow_request_ua_device', 'l7Flow_request_ua_browser', 'l7Flow_request_ua_os', 'l7Flow_request_ua']
        };

        const metricLabels = {
            'l7Flow_flux': 'æ€»æµé‡',
            'l7Flow_inFlux': 'å®¢æˆ·ç«¯è¯·æ±‚æµé‡',
            'l7Flow_outFlux': 'å“åº”æµé‡',
            'l7Flow_bandwidth': 'æ€»å¸¦å®½',
            'l7Flow_inBandwidth': 'è¯·æ±‚å¸¦å®½',
            'l7Flow_outBandwidth': 'å“åº”å¸¦å®½',
            'l7Flow_outFlux_hy': 'å›æºè¯·æ±‚æµé‡',
            'l7Flow_inFlux_hy': 'å›æºå“åº”æµé‡',
            'l7Flow_outBandwidth_hy': 'å›æºè¯·æ±‚å¸¦å®½',
            'l7Flow_inBandwidth_hy': 'å›æºå“åº”å¸¦å®½',
            'l7Flow_request_hy': 'å›æºè¯·æ±‚æ•°',
            'l7Flow_request': 'è¯·æ±‚æ•°',
            'l7Flow_avgResponseTime': 'å¹³å‡å“åº”è€—æ—¶',
            'l7Flow_avgFirstByteResponseTime': 'å¹³å‡é¦–å­—èŠ‚è€—æ—¶',
            'function_requestCount': 'Edge Functions è¯·æ±‚æ•°',
            'function_cpuCostTime': 'Edge Functions CPU æ—¶é—´',
            'ccAcl_interceptNum': 'ç²¾ç¡®é˜²æŠ¤æ‹¦æˆª',
            'ccManage_interceptNum': 'æ‰˜ç®¡è§„åˆ™æ‹¦æˆª',
            'ccRate_interceptNum': 'é€Ÿç‡é™åˆ¶æ‹¦æˆª',
            'l7Flow_outFlux_country': 'å›½å®¶/åœ°åŒºæµé‡',
            'l7Flow_outFlux_province': 'å›½å†…çœä»½æµé‡',
            'l7Flow_outFlux_statusCode': 'çŠ¶æ€ç æµé‡',
            'l7Flow_outFlux_domain': 'åŸŸåæµé‡',
            'l7Flow_outFlux_url': 'URL æµé‡',
            'l7Flow_outFlux_resourceType': 'èµ„æºç±»å‹æµé‡',
            'l7Flow_outFlux_sip': 'å®¢æˆ·ç«¯IPæµé‡',
            'l7Flow_outFlux_referers': 'Referer æµé‡',
            'l7Flow_outFlux_ua_device': 'è®¾å¤‡ç±»å‹æµé‡',
            'l7Flow_outFlux_ua_browser': 'æµè§ˆå™¨æµé‡',
            'l7Flow_outFlux_ua_os': 'æ“ä½œç³»ç»Ÿæµé‡',
            'l7Flow_outFlux_ua': 'User Agent æµé‡',
            'l7Flow_request_country': 'å›½å®¶/åœ°åŒºè¯·æ±‚æ•°',
            'l7Flow_request_province': 'å›½å†…çœä»½è¯·æ±‚æ•°',
            'l7Flow_request_statusCode': 'çŠ¶æ€ç è¯·æ±‚æ•°',
            'l7Flow_request_domain': 'åŸŸåè¯·æ±‚æ•°',
            'l7Flow_request_url': 'URL è¯·æ±‚æ•°',
            'l7Flow_request_resourceType': 'èµ„æºç±»å‹è¯·æ±‚æ•°',
            'l7Flow_request_sip': 'å®¢æˆ·ç«¯IPè¯·æ±‚æ•°',
            'l7Flow_request_referers': 'Referer è¯·æ±‚æ•°',
            'l7Flow_request_ua_device': 'è®¾å¤‡ç±»å‹è¯·æ±‚æ•°',
            'l7Flow_request_ua_browser': 'æµè§ˆå™¨è¯·æ±‚æ•°',
            'l7Flow_request_ua_os': 'æ“ä½œç³»ç»Ÿè¯·æ±‚æ•°',
            'l7Flow_request_ua': 'User Agent è¯·æ±‚æ•°'
        };

        const metricColors = {
            'l7Flow_flux': '#3b82f6', // blue
            'l7Flow_inFlux': '#f59e0b', // amber
            'l7Flow_outFlux': '#10b981', // green
            'l7Flow_bandwidth': '#8b5cf6', // purple
            'l7Flow_inBandwidth': '#ec4899', // pink
            'l7Flow_outBandwidth': '#06b6d4', // cyan
            'l7Flow_outFlux_hy': '#3b82f6', // blue
            'l7Flow_inFlux_hy': '#10b981', // green
            'l7Flow_outBandwidth_hy': '#8b5cf6', // purple
            'l7Flow_inBandwidth_hy': '#ec4899', // pink
            'l7Flow_request_hy': '#f43f5e', // rose
            'l7Flow_request': '#f43f5e', // rose
            'l7Flow_avgResponseTime': '#ef4444', // red
            'l7Flow_avgFirstByteResponseTime': '#f97316', // orange
            'function_requestCount': '#8b5cf6', // purple
            'function_cpuCostTime': '#06b6d4', // cyan
            'ccAcl_interceptNum': '#ef4444', // red
            'ccManage_interceptNum': '#f59e0b', // amber
            'ccRate_interceptNum': '#3b82f6', // blue
            'l7Flow_outFlux_country': '#3b82f6', // blue
            'l7Flow_outFlux_province': '#f59e0b', // amber
            'l7Flow_outFlux_statusCode': '#8b5cf6', // purple
            'l7Flow_outFlux_domain': '#06b6d4', // cyan
            'l7Flow_outFlux_url': '#10b981', // green
            'l7Flow_outFlux_resourceType': '#f59e0b', // amber
            'l7Flow_outFlux_sip': '#ef4444', // red
            'l7Flow_outFlux_referers': '#8b5cf6', // purple
            'l7Flow_outFlux_ua_device': '#06b6d4', // cyan
            'l7Flow_outFlux_ua_browser': '#f59e0b', // amber
            'l7Flow_outFlux_ua_os': '#10b981', // green
            'l7Flow_outFlux_ua': '#8b5cf6', // purple
            'l7Flow_request_country': '#3b82f6', // blue
            'l7Flow_request_province': '#f59e0b', // amber
            'l7Flow_request_statusCode': '#8b5cf6', // purple
            'l7Flow_request_domain': '#06b6d4', // cyan
            'l7Flow_request_url': '#10b981', // green
            'l7Flow_request_resourceType': '#f59e0b', // amber
            'l7Flow_request_sip': '#8b5cf6', // purple
            'l7Flow_request_referers': '#ec4899', // pink
            'l7Flow_request_ua_device': '#06b6d4', // cyan
            'l7Flow_request_ua_browser': '#10b981', // green
            'l7Flow_request_ua_os': '#f59e0b', // amber
            'l7Flow_request_ua': '#8b5cf6' // purple
        };

        /** Tool Functions **/

        function formatDate(date) {
            return date.toISOString().slice(0, 19) + 'Z';
        }

        function handleTimeRangeChange() {
            const range = document.getElementById('timeRange').value;
            const customInputs = document.getElementById('customTimeInputs');
            if (range === 'custom') {
                customInputs.classList.remove('hidden');
                customInputs.classList.add('flex');
            } else {
                customInputs.classList.add('hidden');
                customInputs.classList.remove('flex');
                refreshData();
            }
        }

        function calculateTimeRange() {
            const range = document.getElementById('timeRange').value;
            const now = new Date();
            let endTime = new Date(now);
            let startTime;

            switch(range) {
                case '30min': startTime = new Date(now.getTime() - 30 * 60 * 1000); break;
                case '1h': startTime = new Date(now.getTime() - 1 * 60 * 60 * 1000); break;
                case '6h': startTime = new Date(now.getTime() - 6 * 60 * 60 * 1000); break;
                case 'today': 
                    startTime = new Date(now);
                    startTime.setHours(0, 0, 0, 0);
                    break;
                case 'yesterday':
                    startTime = new Date(now);
                    startTime.setDate(now.getDate() - 1);
                    startTime.setHours(0, 0, 0, 0);
                    
                    endTime = new Date(now);
                    endTime.setDate(now.getDate() - 1);
                    endTime.setHours(23, 59, 59, 999);
                    break;
                case '3d': startTime = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000); break;
                case '7d': startTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); break;
                case '14d': startTime = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000); break;
                case '31d': startTime = new Date(now.getTime() - 31 * 24 * 60 * 60 * 1000); break;
                case 'custom':
                    const days = parseInt(document.getElementById('customDays').value) || 0;
                    const hours = parseInt(document.getElementById('customHours').value) || 0;
                    const minutes = parseInt(document.getElementById('customMinutes').value) || 0;
                    const seconds = parseInt(document.getElementById('customSeconds').value) || 0;
                    
                    let totalMs = ((days * 24 * 60 * 60) + (hours * 60 * 60) + (minutes * 60) + seconds) * 1000;
                    const maxMs = 31 * 24 * 60 * 60 * 1000; // 31 days limit
                    const errorEl = document.getElementById('timeRangeError');

                    if (totalMs > maxMs) {
                        if (errorEl) errorEl.innerText = 'è‡ªå®šä¹‰æ—¶é—´èŒƒå›´ä¸èƒ½è¶…è¿‡ 31 å¤©ï¼Œå·²è‡ªåŠ¨ä¸ºæ‚¨è°ƒæ•´ä¸º 31 å¤©ã€‚';
                        totalMs = maxMs;
                    } else {
                        if (errorEl) errorEl.innerText = '';
                    }

                    if (totalMs > 0) {
                        startTime = new Date(now.getTime() - totalMs);
                    } else {
                        // Default to 1 hour if nothing entered
                        startTime = new Date(now.getTime() - 60 * 60 * 1000);
                    }
                    break;
                default: startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            }

            return {
                startTime: formatDate(startTime),
                endTime: formatDate(endTime)
            };
        }

        function calculatePreviousRange(startStr, endStr) {
            const start = new Date(startStr);
            const end = new Date(endStr);
            const duration = end.getTime() - start.getTime();
            const prevEnd = new Date(start.getTime()); 
            const prevStart = new Date(prevEnd.getTime() - duration);
            return {
                prevStartTime: formatDate(prevStart),
                prevEndTime: formatDate(prevEnd)
            };
        }

        function renderGrowth(elementId, currentVal, prevVal, inverse = false) {
            const el = document.getElementById(elementId);
            if (!el) return;

            let growthEl = document.getElementById(elementId + '_growth');
            if (!growthEl) {
                growthEl = document.createElement('span');
                growthEl.id = elementId + '_growth';
                el.appendChild(growthEl);
            }

            if (prevVal === 0) {
                growthEl.innerText = ''; 
                return;
            }

            const growth = ((currentVal - prevVal) / prevVal) * 100;
            const absGrowth = Math.abs(growth).toFixed(2);
            
            // Color Logic: 
            // All: Increase = Red, Decrease = Green
            
            let colorClass = 'text-gray-500';
            let icon = '';
            
            if (growth > 0) {
                icon = 'â†‘';
                colorClass = 'text-red-500';
            } else if (growth < 0) {
                icon = 'â†“';
                colorClass = 'text-green-500';
            } else {
                icon = '-';
            }

            growthEl.className = `text-sm font-normal ml-2 ${colorClass}`;
            growthEl.innerText = `${icon} ${absGrowth}%`;
        }

        async function fetchData(metric, customStart, customEnd) {
            try {
                let startTime, endTime;
                if (customStart && customEnd) {
                    startTime = customStart;
                    endTime = customEnd;
                } else {
                    const range = calculateTimeRange();
                    startTime = range.startTime;
                    endTime = range.endTime;
                }

                const interval = document.getElementById('interval').value;
                const zoneId = '*';
                
                let url = `/api/traffic?metric=${metric}&startTime=${encodeURIComponent(startTime)}&endTime=${encodeURIComponent(endTime)}`;
                if (interval && interval !== 'auto') {
                    url += `&interval=${interval}`;
                }
                if (zoneId) {
                    url += `&zoneId=${encodeURIComponent(zoneId)}`;
                }

                const response = await fetch(url);
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                return result;
            } catch (err) {
                console.error(`Error fetching ${metric}:`, err);
                return null;
            }
        }

        function processData(result, targetMetric) {
            // Check for Top Data Structure (DescribeTopL7AnalysisData)
            // It returns Data[0].DetailData (Array of Key/Value)
            if (result?.Data?.[0]?.DetailData) {
                 return {
                     type: 'top',
                     data: result.Data[0].DetailData
                 };
            }

            // DescribeTimingL7AnalysisData returns 'Data'
            // DescribeTimingL7OriginPullData returns 'TimingDataRecords'
            const dataList = result?.Data || result?.TimingDataRecords || [];
            if (dataList.length === 0) return { timeData: [], valueData: [], sum: 0, max: 0, avg: 0, type: 'time' };

            let typeValue;
            
            // Try to find matching metric in TypeValue or Value
            if (targetMetric) {
                if (dataList[0]?.TypeValue) {
                    typeValue = dataList[0].TypeValue.find(item => item.MetricName === targetMetric);
                } else if (dataList[0]?.Value) {
                    typeValue = dataList[0].Value.find(item => item.MetricName === targetMetric);
                }
            }

            // Fallback if not found or no targetMetric (or if only one exists)
            if (!typeValue) {
                 typeValue = dataList[0]?.TypeValue?.[0];
                 // Support DescribeWebProtectionData structure (Value instead of TypeValue)
                 if (!typeValue && dataList[0]?.Value?.[0]) {
                    typeValue = dataList[0].Value[0];
                 }
            }

            const details = typeValue?.Detail || [];
            const sum = typeValue?.Sum || 0;
            const max = typeValue?.Max || 0;
            const avg = typeValue?.Avg || 0;

            const timeData = [];
            const valueData = [];

            // Context for formatting
            const range = document.getElementById('timeRange')?.value || '30min';
            const interval = document.getElementById('interval')?.value || 'auto';
            const longRanges = ['3d', '7d', '14d', '31d'];
            
            // Auto-detect if interval is effectively 'day'
            let isDayInterval = interval === 'day';
            if (interval === 'auto' && details.length > 1) {
                const diff = details[1].Timestamp - details[0].Timestamp;
                // If interval is >= 23 hours (allow some slack), treat as day
                if (diff >= 82800) isDayInterval = true;
            }
            // If auto and range is 31d/15d, it usually defaults to day
            if (interval === 'auto' && ['14d', '31d'].includes(range)) {
                // Check if we have few points (e.g. < 32 for 31d), likely day
                if (details.length <= 32) isDayInterval = true;
            }

            // Calculate time span of the data
            let span = 0;
            if (details.length > 0) {
                 span = details[details.length - 1].Timestamp - details[0].Timestamp;
            }

            details.forEach(item => {
                const date = new Date(item.Timestamp * 1000);
                let label;

                if (isDayInterval) {
                    // Show YYYY-MM-DD
                    label = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                } else if (span > 86400 || longRanges.includes(range) || (range === 'custom' && span > 86400)) {
                    // Show MM-DD HH:mm for long ranges or custom > 24h
                    label = `${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                } else {
                    // Show HH:mm for short ranges
                    label = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                }

                timeData.push(label);
                valueData.push(item.Value);
            });

            return { timeData, valueData, sum, max, avg, type: 'time' };
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            if (i < 0) return bytes + ' B';
            if (i >= sizes.length) return (bytes / Math.pow(k, sizes.length - 1)).toFixed(2) + ' ' + sizes[sizes.length - 1];
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatBps(bps) {
            if (bps === 0) return '0 bps';
            const k = 1024;
            const sizes = ['bps', 'Kbps', 'Mbps', 'Gbps', 'Tbps', 'Pbps', 'Ebps', 'Zbps', 'Ybps'];
            const i = Math.floor(Math.log(bps) / Math.log(k));
            if (i < 0) return bps + ' bps';
            if (i >= sizes.length) return (bps / Math.pow(k, sizes.length - 1)).toFixed(2) + ' ' + sizes[sizes.length - 1];
            return parseFloat((bps / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatCount(num) {
            if (num === 0) return '0';
            if (num < 1000) return num.toString();
            if (num < 10000) return (num / 1000).toFixed(2) + ' åƒ';
            if (num < 100000000) return (num / 10000).toFixed(2) + ' ä¸‡';
            return (num / 100000000).toFixed(2) + ' äº¿';
        }

        function getBestCountUnit(maxValue) {
            if (maxValue < 1000) return { unit: 'æ¬¡', divisor: 1 };
            if (maxValue < 10000) return { unit: 'åƒæ¬¡', divisor: 1000 };
            if (maxValue < 100000000) return { unit: 'ä¸‡æ¬¡', divisor: 10000 };
            return { unit: 'äº¿æ¬¡', divisor: 100000000 };
        }

        function getBestUnit(maxValue, type = 'bytes') {
            const k = 1024;
            const byteUnits = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
            const bitUnits = ['bps', 'Kbps', 'Mbps', 'Gbps', 'Tbps', 'Pbps'];
            const units = type === 'bandwidth' ? bitUnits : byteUnits;

            if (maxValue === 0) return { unit: units[0], divisor: 1 };

            let i = Math.floor(Math.log(maxValue) / Math.log(k));
            if (i < 0) i = 0;
            if (i >= units.length) i = units.length - 1;

            return { unit: units[i], divisor: Math.pow(k, i) };
        }

        

        ////ENTRANCE////
        async function initDashboard() {
            // Initialize charts
            chartTraffic = echarts.init(document.getElementById('chart_traffic'));
            chartBandwidth = echarts.init(document.getElementById('chart_bandwidth'));
            chartRequests = echarts.init(document.getElementById('chart_requests'));
            chartPerformance = echarts.init(document.getElementById('chart_performance'));
            chartSecurity = echarts.init(document.getElementById('chart_security'));
            chartOriginPull = echarts.init(document.getElementById('chart_origin_pull'));
            chartTopCountry = echarts.init(document.getElementById('chart_top_country'));
            chartTopProvince = echarts.init(document.getElementById('chart_top_province'));
            chartTopStatusCode = echarts.init(document.getElementById('chart_top_status_code'));
            chartTopDomain = echarts.init(document.getElementById('chart_top_domain'));
            chartTopUrl = echarts.init(document.getElementById('chart_top_url'));
            chartTopResourceType = echarts.init(document.getElementById('chart_top_resource_type'));
            chartTopSip = echarts.init(document.getElementById('chart_top_sip'));
            chartTopReferer = echarts.init(document.getElementById('chart_top_referer'));
            chartTopUaDevice = echarts.init(document.getElementById('chart_top_ua_device'));
            chartTopUaBrowser = echarts.init(document.getElementById('chart_top_ua_browser'));
            chartTopUaOs = echarts.init(document.getElementById('chart_top_ua_os'));
            chartTopUa = echarts.init(document.getElementById('chart_top_ua'));
            chartTopRequestCountry = echarts.init(document.getElementById('chart_top_request_country'));
            chartTopRequestProvince = echarts.init(document.getElementById('chart_top_request_province'));
            chartTopRequestStatusCode = echarts.init(document.getElementById('chart_top_request_status_code'));
            chartTopRequestDomain = echarts.init(document.getElementById('chart_top_request_domain'));
            chartTopRequestUrl = echarts.init(document.getElementById('chart_top_request_url'));
            chartTopRequestResourceType = echarts.init(document.getElementById('chart_top_request_resource_type'));
            chartTopRequestSip = echarts.init(document.getElementById('chart_top_request_sip'));
            chartTopRequestReferer = echarts.init(document.getElementById('chart_top_request_referer'));
            chartTopRequestUaDevice = echarts.init(document.getElementById('chart_top_request_ua_device'));
            chartTopRequestUaBrowser = echarts.init(document.getElementById('chart_top_request_ua_browser'));
            chartTopRequestUaOs = echarts.init(document.getElementById('chart_top_request_ua_os'));
            chartTopRequestUa = echarts.init(document.getElementById('chart_top_request_ua'));
            chartTopMap = echarts.init(document.getElementById('chart_top_map'));
            chartFunctionRequests = echarts.init(document.getElementById('chart_function_requests'));
            chartFunctionCpu = echarts.init(document.getElementById('chart_function_cpu'));
            chartPagesCloudFunctionRequests = echarts.init(document.getElementById('chart_pages_cloud_function_requests'));

            await refreshData();
        }

        async function fetchPagesBuildStats() {
             try {
                // Pages build stats are global, not per zone (usually), or the API handles it.
                // If it needs zoneId, we might need to pass it.
                // The current backend implementation just calls DescribePagesResources without params, 
                // so it likely returns account-level or default zone stats.
                // However, the user request implied it's a new API. 
                // Let's assume it doesn't need time range or zoneId for now as per backend implementation.
                
                // Get ZoneId if selected
                const zoneIdElement = document.getElementById('zoneId');
                const zoneId = zoneIdElement ? zoneIdElement.value : null;
				const t = Date.now();
                const url = zoneId && zoneId !== '*' ? `/api/pages/build-count?zoneId=${zoneId}` : '/api/pages/build-count?t='+ t;

                const response = await fetch(url);
                const result = await response.json();
                
                if (result.parsedResult) {
                    const { dplDailyCount, dplMonthCount } = result.parsedResult;
                    document.getElementById('kpi_pages_daily_build').innerText = dplDailyCount !== undefined ? dplDailyCount : '-';
                    document.getElementById('kpi_pages_monthly_build').innerText = dplMonthCount !== undefined ? dplMonthCount : '-';
                } else {
                     document.getElementById('kpi_pages_daily_build').innerText = '-';
                     document.getElementById('kpi_pages_monthly_build').innerText = '-';
                }
                return true;

            } catch (err) {
                console.error("Error fetching pages build stats:", err);
                document.getElementById('kpi_pages_daily_build').innerText = 'Error';
                document.getElementById('kpi_pages_monthly_build').innerText = 'Error';
                return false;
            }
        }

        async function fetchPagesCloudFunctionStats(startTime, endTime) {
            try {
                // Get ZoneId if selected
                const zoneIdElement = document.getElementById('zoneId');
                const zoneId = zoneIdElement ? zoneIdElement.value : null;
                
                let url = zoneId && zoneId !== '*' ? `/api/pages/cloud-function-requests?zoneId=${zoneId}` : '/api/pages/cloud-function-requests';
                
                // Add time range params if provided
                if (startTime && endTime) {
                    const separator = url.includes('?') ? '&' : '?';
                    url += `${separator}startTime=${encodeURIComponent(startTime)}&endTime=${encodeURIComponent(endTime)}`;
                }

                const response = await fetch(url);
                const result = await response.json();
                
                // Parsed Result: { Status, Granularity, Timestamps, Values, TotalValue }
                if (result.parsedResult) {
                    const { TotalValue, Timestamps, Values } = result.parsedResult;
                    
                    // Update KPI
                    document.getElementById('kpi_pages_cloud_function_total').innerText = TotalValue !== undefined ? TotalValue : '-';
                    
                    // Update Chart
                    if (Timestamps && Values && Timestamps.length > 0) {
                         const dates = Timestamps.map(ts => {
                            // Timestamps are in seconds, convert to local string
                            return new Date(ts * 1000).toLocaleString('zh-CN', { month: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric' });
                        });

                        const option = {
                            tooltip: {
                                trigger: 'axis'
                            },
                            grid: {
                                left: '3%',
                                right: '4%',
                                bottom: '3%',
                                containLabel: true
                            },
                            xAxis: {
                                type: 'category',
                                boundaryGap: false,
                                data: dates,
                                axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                            },
                            yAxis: {
                                type: 'value',
                                axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                            },
                            series: [
                                {
                                    name: 'Requests',
                                    type: 'line',
                                    smooth: true,
                                    data: Values,
                                    areaStyle: {
                                        opacity: 0.1
                                    },
                                    itemStyle: {
                                        color: '#3b82f6'
                                    }
                                }
                            ]
                        };
                        chartPagesCloudFunctionRequests.setOption(option);
                    } else {
                        chartPagesCloudFunctionRequests.clear();
                    }

                } else {
                     document.getElementById('kpi_pages_cloud_function_total').innerText = '-';
                     chartPagesCloudFunctionRequests.clear();
                }
                return true;
            } catch (err) {
                console.error("Error fetching pages cloud function stats:", err);
                document.getElementById('kpi_pages_cloud_function_total').innerText = 'Error';
                chartPagesCloudFunctionRequests.clear();
                return false;
            }
        }

        async function fetchPagesCloudFunctionMonthlyStats() {
            try {
                // Get ZoneId if selected
                const zoneIdElement = document.getElementById('zoneId');
                const zoneId = zoneIdElement ? zoneIdElement.value : null;
				const t = Date.now();
                const url = zoneId && zoneId !== '*' ? `/api/pages/cloud-function-monthly-stats?zoneId=${zoneId}` : '/api/pages/cloud-function-monthly-stats?t=' + t;
                
                const response = await fetch(url);
                const result = await response.json();
                
                // Expected Result: { parsedResult: { TotalMemDuration: number, TotalInvocation: number } }
                if (result.parsedResult) {
                    const { TotalMemDuration, TotalInvocation } = result.parsedResult;
                    
                    // Update Requests KPI
                    document.getElementById('kpi_pages_monthly_cf_requests').innerText = TotalInvocation !== undefined ? TotalInvocation : '-';
                    
                    // Update GBs KPI (TotalMemDuration / 1024)
                    if (TotalMemDuration !== undefined) {
                        const gbs = (TotalMemDuration / 1024).toFixed(2);
                        document.getElementById('kpi_pages_monthly_cf_gbs').innerText = gbs;
                    } else {
                        document.getElementById('kpi_pages_monthly_cf_gbs').innerText = '-';
                    }

                } else {
                     document.getElementById('kpi_pages_monthly_cf_requests').innerText = '-';
                     document.getElementById('kpi_pages_monthly_cf_gbs').innerText = '-';
                }
                return true;
            } catch (err) {
                console.error("Error fetching pages cloud function monthly stats:", err);
                document.getElementById('kpi_pages_monthly_cf_requests').innerText = 'Error';
                document.getElementById('kpi_pages_monthly_cf_gbs').innerText = 'Error';
                return false;
            }
        }

        async function refreshData() {
            // Show loading
            document.querySelectorAll('[id^="kpi_"]').forEach(el => {
                 if (!el.id.includes('growth')) el.innerText = 'åŠ è½½ä¸­...';
            });

            // Initialize Progress Bar
            const progressBar = document.getElementById('loading-progress-bar');
            if (progressBar) {
                progressBar.style.width = '0%';
                progressBar.classList.remove('bg-red-500');
                progressBar.classList.add('bg-blue-500');
                progressBar.parentElement.classList.remove('opacity-0');
                progressBar.parentElement.classList.remove('hidden');
            }

            // Check time range for Security Metrics
            const { startTime, endTime } = calculateTimeRange();
            const start = new Date(startTime);
            const end = new Date(endTime);
            // Allow a small buffer (e.g., 1 minute) for "7 days" check to handle slight offsets
            const isSecuritySupported = (end - start) <= (14 * 24 * 60 * 60 * 1000 + 60000);

            // Fetch all metrics
            const allMetrics = [
                ...metricsConfig.traffic,
                ...metricsConfig.bandwidth,
                ...metricsConfig.originPull,
                ...metricsConfig.requests,
                ...metricsConfig.performance,
                ...metricsConfig.edgeFunctions,
                ...(isSecuritySupported ? metricsConfig.security : []),
                ...metricsConfig.topAnalysis
            ];

            const results = {};
            
            // Progress Bar Logic
            let totalTasks = 3 + allMetrics.length * 2;
            let completedTasks = 0;
            let hasError = false;

            const updateProgress = (success = true) => {
                completedTasks++;
                if (!success) hasError = true;
                
                const percentage = Math.min((completedTasks / totalTasks) * 100, 100);
                if (progressBar) {
                    progressBar.style.width = `${percentage}%`;
                    if (hasError) {
                        progressBar.classList.remove('bg-blue-500');
                        progressBar.classList.add('bg-red-500');
                    }
                    
                    if (completedTasks >= totalTasks) {
                        setTimeout(() => {
                             progressBar.style.width = '100%'; // Ensure full width
                             setTimeout(() => {
                                 progressBar.style.width = '0%';
                                 // progressBar.parentElement.classList.add('hidden'); 
                             }, 500);
                        }, 200);
                    }
                }
            };
            
            // Start Pages Build Stats fetch (independent)
            fetchPagesBuildStats().then((res) => updateProgress(res));
            // Start Pages Cloud Function Stats fetch (independent) - Pass time range
            fetchPagesCloudFunctionStats(startTime, endTime).then((res) => updateProgress(res));
            // Start Pages Cloud Function Monthly Stats fetch (independent)
            fetchPagesCloudFunctionMonthlyStats().then((res) => updateProgress(res));

            // Parallel fetch
            // calculateTimeRange called above (line 1606), reusing startTime/endTime variables
            const { prevStartTime, prevEndTime } = calculatePreviousRange(startTime, endTime);

            // Group metrics by section for efficient updates
            const updateMap = {
                'traffic': updateTrafficSection,
                'bandwidth': updateBandwidthSection,
                'originPull': updateOriginPullSection,
                'requests': updateRequestsSection,
                'performance': updatePerformanceSection,
                'edgeFunctions': updateEdgeFunctionsSection,
                'security': updateSecuritySection,
                'topAnalysis': updateTopAnalysisSection
            };

            // Helper to determine which section a metric belongs to
            const getSection = (metric) => {
                 for (const [section, metrics] of Object.entries(metricsConfig)) {
                     if (metrics.includes(metric)) return section;
                 }
                 return null;
            };

            // Track pending updates per section to avoid too many renders (debounce-like)
            // But since we want "show as soon as available", we can update per metric or per section group.
            // Updating per metric might be too granular for charts that share multiple metrics (like Traffic Chart has 3 lines).
            // So we will trigger section update whenever a metric in that section is ready.
            
            // To prevent flickering or partial charts, we might want to wait for all metrics IN A SECTION to be ready?
            // The user said "whichever metric is fetched, show it". 
            // For KPIs, this is easy. For charts with multiple lines, adding one line at a time is fine too (ECharts supports merge).
            
            // Let's iterate all metrics and fire requests in parallel
            allMetrics.forEach((metric) => {
                const section = getSection(metric);

                // 1. Fetch Current Data
                fetchData(metric).then(res => {
                    if (res) {
                        results[metric] = processData(res, metric);
                        // Update UI immediately when current data arrives
                        if (section && updateMap[section]) {
                            updateMap[section](results);
                        }
                        updateProgress(true);
                    } else {
                        updateProgress(false);
                    }
                }).catch(e => {
                    console.error(`Error loading metric ${metric}:`, e);
                    updateProgress(false);
                });

                // 2. Fetch Previous Data (Parallel)
                fetchData(metric, prevStartTime, prevEndTime).then(prevRes => {
                    if (prevRes) {
                        results[metric + '_prev'] = processData(prevRes, metric);
                        // Re-update UI to show growth (only if current data is already there)
                        if (results[metric] && section && updateMap[section]) {
                            updateMap[section](results);
                        }
                        updateProgress(true);
                    } else {
                        // Previous data failure isn't critical, but we track it for progress
                        // We might not want to turn red for missing previous data? 
                        // User said "any API request fails", so let's stick to that.
                        updateProgress(false);
                    }
                }).catch(e => {
                    console.error(`Error loading prev metric ${metric}:`, e);
                    updateProgress(false);
                });
            });

            lastResults = results;
        }

        //1.æœ‰ä½¿ç”¨
        function updateTrafficSection(results) {
            const metrics = metricsConfig.traffic;
            const series = [];
            let timeData = [];

            // Calculate global max
            let globalMax = 0;
            metrics.forEach(metric => {
                const data = results[metric];
                if (data && data.type === 'time') {
                    const max = Math.max(...data.valueData);
                    if (max > globalMax) globalMax = max;
                }
            });

            const { unit, divisor } = getBestUnit(globalMax, 'bytes');

            metrics.forEach(metric => {
                const data = results[metric];
                if (!data || data.type !== 'time') return;
                
                // Update KPI
                document.getElementById(`kpi_${metric}`).innerText = formatBytes(data.sum);

                // Growth
                const prevData = results[metric + '_prev'];
                if (prevData) {
                    renderGrowth(`kpi_${metric}`, data.sum, prevData.sum);
                }

                if (timeData.length === 0) timeData = data.timeData;

                // Chart Data (Dynamic Unit)
                const valueData = data.valueData.map(v => (v / divisor).toFixed(2));
                
                series.push({
                    name: metricLabels[metric],
                    type: 'line',
                    smooth: true,
                    data: valueData,
                    itemStyle: { color: metricColors[metric] },
                    areaStyle: { opacity: 0.1 },
                    // Store raw data for tooltip
                    rawData: data.valueData
                });
            });

            const option = {
                tooltip: { trigger: 'axis', formatter: (params) => {
                    let res = params[0].axisValue + '<br/>';
                    params.forEach(param => {
                        // Access raw data using dataIndex
                        const seriesIndex = param.seriesIndex;
                        const dataIndex = param.dataIndex;
                        const rawVal = series[seriesIndex].rawData[dataIndex];
                        const formattedVal = formatBytes(rawVal);
                        
                        res += `${param.marker}${param.seriesName}: ${formattedVal}<br/>`;
                    });
                    return res;
                }},
                legend: { 
                    data: metrics.map(m => metricLabels[m]), 
                    bottom: 0,
					icon: 'circle',
                    textStyle: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#333' }
                },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                xAxis: { 
                    type: 'category', 
                    boundaryGap: false, 
                    data: timeData,
                    axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                },
                yAxis: { 
                    type: 'value', 
                    name: unit,
                    axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                },
                series: series
            };
            chartTraffic.setOption(option, true);
        }

        //2.æœ‰ä½¿ç”¨
        function updateBandwidthSection(results) {
            const metrics = metricsConfig.bandwidth;
            const series = [];
            let timeData = [];

            // Calculate global max
            let globalMax = 0;
            metrics.forEach(metric => {
                const data = results[metric];
                if (data && data.type === 'time') {
                    const max = Math.max(...data.valueData);
                    if (max > globalMax) globalMax = max;
                }
            });

            const { unit, divisor } = getBestUnit(globalMax, 'bandwidth');

            metrics.forEach(metric => {
                const data = results[metric];
                if (!data || data.type !== 'time') return;
                
                // Update KPI (Max/Peak)
                document.getElementById(`kpi_${metric}`).innerText = formatBps(data.max);

                // Growth
                const prevData = results[metric + '_prev'];
                if (prevData) {
                    renderGrowth(`kpi_${metric}`, data.max, prevData.max);
                }

                if (timeData.length === 0) timeData = data.timeData;

                // Chart Data (Dynamic Unit)
                const valueData = data.valueData.map(v => (v / divisor).toFixed(2));
                
                series.push({
                    name: metricLabels[metric],
                    type: 'line',
                    smooth: true,
                    data: valueData,
                    itemStyle: { color: metricColors[metric] },
                    areaStyle: { opacity: 0.1 },
                    // Store raw data
                    rawData: data.valueData
                });
            });

            const option = {
                tooltip: { trigger: 'axis', formatter: (params) => {
                    let res = params[0].axisValue + '<br/>';
                    params.forEach(param => {
                        const seriesIndex = param.seriesIndex;
                        const dataIndex = param.dataIndex;
                        const rawVal = series[seriesIndex].rawData[dataIndex];
                        const formattedVal = formatBps(rawVal);
                        res += `${param.marker}${param.seriesName}: ${formattedVal}<br/>`;
                    });
                    return res;
                }},
                legend: { 
                    data: metrics.map(m => metricLabels[m]), 
                    bottom: 0,
					icon: 'circle',
                    textStyle: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#333' }
                },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                xAxis: { 
                    type: 'category', 
                    boundaryGap: false, 
                    data: timeData,
                    axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                },
                yAxis: { 
                    type: 'value', 
                    name: unit,
                    axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                },
                series: series
            };
            chartBandwidth.setOption(option);
        }

        //3.æœ‰ä½¿ç”¨
        function updateOriginPullSection(results) {
            const metrics = metricsConfig.originPull;
            const series = [];
            let timeData = [];

            // Calculate global max for Flux, Bandwidth and Requests separately
            let maxFlux = 0;
            let maxBandwidth = 0;
            let maxRequests = 0;

            metrics.forEach(metric => {
                const data = results[metric];
                if (data && data.type === 'time') {
                    const max = Math.max(...data.valueData);
                    if (metric.includes('Flux')) {
                        if (max > maxFlux) maxFlux = max;
                    } else if (metric.includes('Bandwidth')) {
                        if (max > maxBandwidth) maxBandwidth = max;
                    } else if (metric.includes('request')) {
                        if (max > maxRequests) maxRequests = max;
                    }
                }
            });

            const fluxUnit = getBestUnit(maxFlux, 'bytes');
            const bandwidthUnit = getBestUnit(maxBandwidth, 'bandwidth');
            const requestUnit = getBestCountUnit(maxRequests);

            metrics.forEach(metric => {
                const data = results[metric];
                if (!data || data.type !== 'time') return;
                
                // Update KPI
                const kpiEl = document.getElementById(`kpi_${metric}`);
                if (kpiEl) {
                    if (metric.includes('Flux')) {
                         kpiEl.innerText = formatBytes(data.sum);
                    } else if (metric.includes('Bandwidth')) {
                         kpiEl.innerText = formatBps(data.max);
                    } else if (metric.includes('request')) {
                         kpiEl.innerText = formatCount(data.sum);
                    } else {
                         kpiEl.innerText = data.sum.toLocaleString();
                    }

                    // Growth (Inverse=true because more origin pull is usually worse/costly)
                    const prevData = results[metric + '_prev'];
                    if (prevData) {
                        let curVal, preVal;
                        if (metric.includes('Bandwidth')) {
                             curVal = data.max;
                             preVal = prevData.max;
                        } else {
                             curVal = data.sum;
                             preVal = prevData.sum;
                        }
                        renderGrowth(`kpi_${metric}`, curVal, preVal, true);
                    }
                }

                if (timeData.length === 0) timeData = data.timeData;

                let chartData = [];
                let unit = '';
                let divisor = 1;

                // Normalize data for chart
                if (metric.includes('Flux')) {
                    unit = fluxUnit.unit;
                    divisor = fluxUnit.divisor;
                } else if (metric.includes('Bandwidth')) {
                    unit = bandwidthUnit.unit;
                    divisor = bandwidthUnit.divisor;
                } else if (metric.includes('request')) {
                    unit = requestUnit.unit;
                    divisor = requestUnit.divisor;
                } else {
                    unit = '';
                    divisor = 1;
                }

                chartData = data.valueData.map(v => {
                    const val = v / divisor;
                    return (divisor === 1) ? val : val.toFixed(2);
                });

                series.push({
                    name: metricLabels[metric],
                    type: 'line',
                    smooth: true,
                    data: chartData,
                    itemStyle: { color: metricColors[metric] },
                    areaStyle: { opacity: 0.1 },
                    customUnit: unit,
                    rawData: data.valueData
                });
            });

            const option = {
                title: { show: false },
                tooltip: { 
                    trigger: 'axis',
                    formatter: (params) => {
                        let res = params[0].axisValue + '<br/>';
                        params.forEach(param => {
                            const seriesIndex = param.seriesIndex;
                            const dataIndex = param.dataIndex;
                            const rawVal = series[seriesIndex].rawData[dataIndex];
                            
                            const unit = series[seriesIndex].customUnit || '';
                            let formattedVal = '';
                            
                            if (unit.includes('bps')) {
                                formattedVal = formatBps(rawVal);
                            } else if (unit.includes('B')) {
                                formattedVal = formatBytes(rawVal);
                            } else if (unit.includes('åƒ') || unit.includes('ä¸‡') || unit.includes('äº¿')) {
                                formattedVal = formatCount(rawVal);
                            } else {
                                formattedVal = rawVal.toLocaleString();
                            }

                            res += `${param.marker}${param.seriesName}: ${formattedVal}<br/>`;
                        });
                        return res;
                    }
                },
                legend: { 
                    data: metrics.map(m => metricLabels[m]), 
                    bottom: 0,
					icon: 'circle',
                    textStyle: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#333' }
                },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                xAxis: { 
                    type: 'category', 
                    boundaryGap: false, 
                    data: timeData,
                    axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                },
                yAxis: { 
                    type: 'value',
                    axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                },
                series: series
            };
            chartOriginPull.setOption(option);

            // Calculate Cache Hit Rate
            // Formula: 1 - (Origin Response Flux / EdgeOne Response Flux)
            const originFluxData = results['l7Flow_inFlux_hy']; // Origin Response
            const edgeFluxData = results['l7Flow_outFlux']; // EdgeOne Response

            let hitRate = 0;
            if (originFluxData && edgeFluxData && edgeFluxData.sum > 0) {
                hitRate = 1 - (originFluxData.sum / edgeFluxData.sum);
            }
            // Clamp hitRate if necessary (e.g. if origin > edge due to compression diffs, it might be negative, but let's show real value or clamp?)
            // Usually hit rate is 0-1.
            
            const hitRateEl = document.getElementById('kpi_cache_hit_rate');
            if (hitRateEl) {
                hitRateEl.innerText = (hitRate * 100).toFixed(2) + '%';
            }
        }

        //4.æœ‰ä½¿ç”¨
        function updateRequestsSection(results) {
            const metrics = metricsConfig.requests;
            const series = [];
            let timeData = [];

            // Calculate global max
            let globalMax = 0;
            metrics.forEach(metric => {
                const data = results[metric];
                if (data && data.type === 'time') {
                    const max = Math.max(...data.valueData);
                    if (max > globalMax) globalMax = max;
                }
            });

            const { unit, divisor } = getBestCountUnit(globalMax);

            metrics.forEach(metric => {
                const data = results[metric];
                if (!data || data.type !== 'time') return;
                
                // Update KPI
                document.getElementById(`kpi_${metric}`).innerText = formatCount(data.sum);

                // Growth
                const prevData = results[metric + '_prev'];
                if (prevData) {
                    renderGrowth(`kpi_${metric}`, data.sum, prevData.sum);
                }

                if (timeData.length === 0) timeData = data.timeData;

                // Chart Data (Dynamic Unit)
                const valueData = data.valueData.map(v => {
                    const val = v / divisor;
                    return (divisor === 1) ? val : val.toFixed(2);
                });

                series.push({
                    name: metricLabels[metric],
                    type: 'line',
                    smooth: true,
                    data: valueData,
                    itemStyle: { color: metricColors[metric] },
                    areaStyle: { opacity: 0.2 },
                    rawData: data.valueData
                });
            });

            const option = {
                tooltip: { trigger: 'axis', formatter: (params) => {
                    let res = params[0].axisValue + '<br/>';
                    params.forEach(param => {
                        const seriesIndex = param.seriesIndex;
                        const dataIndex = param.dataIndex;
                        const rawVal = series[seriesIndex].rawData[dataIndex];
                        const formattedVal = formatCount(rawVal);
                        res += `${param.marker}${param.seriesName}: ${formattedVal}<br/>`;
                    });
                    return res;
                }},
                grid: { left: '3%', right: '4%', bottom: '3%', top: '15%', containLabel: true },
                xAxis: { 
                    type: 'category', 
                    boundaryGap: false, 
                    data: timeData,
                    axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                },
                yAxis: { 
                    type: 'value', 
                    name: unit,
                    axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                },
                series: series
            };
            chartRequests.setOption(option);
        }

        //5.æœ‰ä½¿ç”¨
        function updatePerformanceSection(results) {
            const metrics = metricsConfig.performance;
            const series = [];
            let timeData = [];

            metrics.forEach(metric => {
                const data = results[metric];
                if (!data || data.type !== 'time') return;
                
                // Update KPI (Avg)
                document.getElementById(`kpi_${metric}`).innerText = data.avg.toFixed(2) + ' ms';

                // Growth (Inverse=true for Latency)
                const prevData = results[metric + '_prev'];
                if (prevData) {
                    renderGrowth(`kpi_${metric}`, data.avg, prevData.avg, true);
                }

                if (timeData.length === 0) timeData = data.timeData;

                series.push({
                    name: metricLabels[metric],
                    type: 'line',
                    smooth: true,
                    data: data.valueData,
                    itemStyle: { color: metricColors[metric] }
                });
            });

            const option = {
                tooltip: { trigger: 'axis', formatter: '{b}<br/>{a}: {c} ms' },
                legend: { 
                    data: metrics.map(m => metricLabels[m]), 
                    bottom: 0,
					icon: 'circle',
                    textStyle: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#333' }
                },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                xAxis: { 
                    type: 'category', 
                    boundaryGap: false, 
                    data: timeData,
                    axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                },
                yAxis: { 
                    type: 'value', 
                    name: 'ms',
                    axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                },
                series: series
            };
            chartPerformance.setOption(option);
        }

        function updateEdgeFunctionsSection(results) {
            const metrics = metricsConfig.edgeFunctions;
            
            // Map metrics to specific charts and KPIs
            const metricMap = {
                'function_requestCount': {
                    chart: chartFunctionRequests,
                    kpiId: 'kpi_function_requestCount',
                    unitType: 'count',
                    color: metricColors['function_requestCount']
                },
                'function_cpuCostTime': {
                    chart: chartFunctionCpu,
                    kpiId: 'kpi_function_cpuCostTime',
                    unitType: 'ms',
                    color: metricColors['function_cpuCostTime']
                }
            };

            metrics.forEach(metric => {
                const config = metricMap[metric];
                if (!config) return;

                const data = results[metric];
                if (!data || data.type !== 'time') return;

                // Update KPI
                const kpiEl = document.getElementById(config.kpiId);
                if (kpiEl) {
                    if (config.unitType === 'count') {
                        kpiEl.innerText = formatCount(data.sum);
                    } else if (config.unitType === 'ms') {
                        // Format large numbers with commas
                        kpiEl.innerText = data.sum.toLocaleString() + ' ms';
                    }

                    // Growth
                    const prevData = results[metric + '_prev'];
                    if (prevData) {
                        const curVal = data.sum;
                        const preVal = prevData.sum;
                        // Inverse if ms (CPU Cost)
                        renderGrowth(config.kpiId, curVal, preVal, config.unitType === 'ms');
                    }
                }

                // Chart
                const chart = config.chart;
                if (!chart) return;

                let seriesData = data.valueData;
                let unit = '';
                let divisor = 1;

                if (config.unitType === 'count') {
                     const best = getBestCountUnit(Math.max(...data.valueData));
                     unit = best.unit;
                     divisor = best.divisor;
                     seriesData = data.valueData.map(v => {
                        const val = v / divisor;
                        return (divisor === 1) ? val : val.toFixed(2);
                     });
                } else if (config.unitType === 'ms') {
                     unit = 'ms';
                }

                const option = {
                    tooltip: { trigger: 'axis', formatter: (params) => {
                        let res = params[0].axisValue + '<br/>';
                        params.forEach(param => {
                            const val = data.valueData[param.dataIndex];
                            let formattedVal = val;
                            if (config.unitType === 'count') formattedVal = formatCount(val);
                            else formattedVal = val.toLocaleString() + ' ms';
                            
                            res += `${param.marker}${param.seriesName}: ${formattedVal}<br/>`;
                        });
                        return res;
                    }},
                    legend: { 
                        data: [metricLabels[metric]], 
                        bottom: 0,
						icon: 'circle',
                        textStyle: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#333' }
                    },
                    grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                    xAxis: { 
                        type: 'category', 
                        boundaryGap: false, 
                        data: data.timeData,
                        axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                    },
                    yAxis: { 
                        type: 'value', 
                        name: unit,
                        axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                    },
                    series: [{
                        name: metricLabels[metric],
                        type: 'line',
                        smooth: true,
                        data: seriesData,
                        itemStyle: { color: config.color },
                        areaStyle: { opacity: 0.1 }
                    }]
                };
                chart.setOption(option);
            });
        }

        //5.1. Security Section
        function updateSecuritySection(results) {
            const metrics = metricsConfig.security;
            
            // Check time range limit
            const { startTime, endTime } = calculateTimeRange();
            const start = new Date(startTime);
            const end = new Date(endTime);
            // Allow a small buffer
            if ((end - start) > (14 * 24 * 60 * 60 * 1000 + 60000)) {
                const kpiEl = document.getElementById('kpi_security_hits');
                if (kpiEl) {
                    kpiEl.innerText = "èŒƒå›´è¿‡å¤§";
                    kpiEl.parentElement.querySelector('p').innerText = "ä»…æ”¯æŒæŸ¥è¯¢14å¤©å†…çš„æ•°æ®";
                    kpiEl.parentElement.querySelector('p').classList.add('text-red-500');
                }
                
                chartSecurity.clear();
                chartSecurity.setOption({
                     title: {
                         text: 'è¯¥æŒ‡æ ‡ä»…æ”¯æŒæŸ¥è¯¢14å¤©å†…çš„æ•°æ®',
                         left: 'center',
                         top: 'center',
                         textStyle: { color: document.documentElement.classList.contains('dark') ? '#9ca3af' : '#9ca3af', fontSize: 14, fontWeight: 'normal' }
                     }
                });
                return;
            }
            
            // Reset error style if applicable
            const kpiEl = document.getElementById('kpi_security_hits');
            if (kpiEl) {
                const p = kpiEl.parentElement.querySelector('p');
                if (p) {
                    p.innerText = "DDoS/CC é˜²æŠ¤æ€»æ‹¦æˆªæ¬¡æ•°";
                    p.classList.remove('text-red-500');
                }
            }

            const series = [];
            let timeData = [];
            let totalHits = 0;

            metrics.forEach(metric => {
                const data = results[metric];
                if (!data || data.type !== 'time') return;
                
                totalHits += data.sum;

                if (timeData.length === 0) timeData = data.timeData;

                series.push({
                    name: metricLabels[metric],
                    type: 'line',
                    smooth: true,
                    stack: 'Total', // Stacked area chart
                    areaStyle: {},
                    emphasis: { focus: 'series' },
                    data: data.valueData,
                    itemStyle: { color: metricColors[metric] }
                });
            });

            // Update KPI
            if (kpiEl) {
                const formatted = formatCount(totalHits);
                kpiEl.innerText = formatted;

                // Growth
                let prevTotalHits = 0;
                let hasPrev = false;
                metrics.forEach(metric => {
                    const pd = results[metric + '_prev'];
                    if (pd) { prevTotalHits += pd.sum; hasPrev = true; }
                });
                if (hasPrev) renderGrowth('kpi_security_hits', totalHits, prevTotalHits, true);
            }

            const option = {
                title: { show: false },
                tooltip: { 
                    trigger: 'axis', 
                    axisPointer: { type: 'cross', label: { backgroundColor: '#6a7985' } }
                },
                legend: { 
                    data: metrics.map(m => metricLabels[m]), 
                    bottom: 0,
					icon: 'circle',
                    textStyle: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#333' }
                },
                grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                xAxis: { 
                    type: 'category', 
                    boundaryGap: false, 
                    data: timeData,
                    axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                },
                yAxis: { 
                    type: 'value',
                    axisLabel: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#6E7079' }
                },
                series: series
            };
            chartSecurity.setOption(option);
        }

        //é€šç”¨å¤„ç†
        const renderTopChart = (results, chartInstance, metricName, mapObject = null) => {
            const data = results[metricName];
            const isDark = document.documentElement.classList.contains('dark');

            if (!data || data.type !== 'top' || !data.data) return;

            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10);
            
            let unit = '';
            let divisor = 1;
            let label = metricLabels[metricName] || '';
            
            if (metricName.includes('outFlux')) {
                const maxVal = sortedData.length > 0 ? sortedData[0].Value : 0;
                const best = getBestUnit(maxVal, 'bytes');
                unit = best.unit;
                divisor = best.divisor;
            } else {
                const maxVal = sortedData.length > 0 ? sortedData[0].Value : 0;
                const best = getBestCountUnit(maxVal);
                unit = best.unit;
                divisor = best.divisor;
            }

            const yAxisData = sortedData.map(item => mapObject?.[item.Key] || item.Key).reverse(); //é—®é¢˜ç‚¹ï¼šæ²¡å¯¹â€œå­—æ®µä¸å­˜åœ¨â€çš„çŸ­æ¨ªæ åšåˆ¤æ–­
            const seriesData = sortedData.map(item => {
                const val = item.Value / divisor;
                return (divisor === 1) ? val : val.toFixed(2);
            }).reverse();

            let color = '#3b82f6';
            const lowerName = metricName.toLowerCase();
            if (lowerName.includes('country')) color = '#3b82f6';
            else if (lowerName.includes('province') || lowerName.includes('resourcetype') || lowerName.includes('browser')) color = '#f59e0b';
            else if (lowerName.includes('statuscode') || lowerName.includes('referer') || lowerName.endsWith('_ua')) color = '#8b5cf6';
            else if (lowerName.includes('domain') || lowerName.includes('device')) color = '#06b6d4';
            else if (lowerName.includes('url') || lowerName.includes('os')) color = '#10b981';
            else if (lowerName.includes('sip')) color = '#ef4444';

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         let name = param.name;
                         if (name.length > 100) name = name.substring(0, 100) + '...';
                         
                         const rawVal = sortedData[sortedData.length - 1 - param.dataIndex].Value;
                         
                         let formattedVal = '';
                         if (metricName.includes('outFlux')) {
                             formattedVal = formatBytes(rawVal);
                         } else {
                             const fVal = formatCount(rawVal);
                             // Append 'æ¬¡' if not present in unit (formatCount returns unit, but we might want explicit 'æ¬¡')
                             // formatCount returns "1.23 ä¸‡". "1.23 ä¸‡æ¬¡" sounds good.
                             // "500" -> "500 æ¬¡".
                             formattedVal = fVal + (fVal.includes('åƒ') || fVal.includes('ä¸‡') || fVal.includes('äº¿') ? 'æ¬¡' : ' æ¬¡');
                         }
                         
                         return `${name}<br/>${param.marker}${label}: ${formattedVal}`;
                    }
                },
                grid: { left: '3%', right: '10%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: unit, axisLabel: { color: isDark ? '#e5e7eb' : '#6E7079' } },
                yAxis: { 
                    type: 'category', 
                    data: yAxisData,
                    axisLabel: {
                        color: isDark ? '#e5e7eb' : '#6E7079',
                        formatter: function (value) {
                            if (value.length > 20) return value.substring(0, 20) + '...';
                            return value;
                        }
                    }
                },
                series: [
                    {
                        name: label,
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: color },
                        label: { 
                            show: true, 
                            position: 'right',
                            color: isDark ? '#e5e7eb' : '#111827'
                        }
                    }
                ]
            };
            chartInstance.setOption(option);
        };

        function updateTopMapChart(results) {
            const metric = 'l7Flow_request_country';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            // Map data to ECharts format
            // IMPORTANT: The 'name' here must match the region name AFTER nameMap is applied.
            // Since worldNameMap maps English names to Chinese (e.g. "China" -> "ä¸­å›½å¤§é™†"),
            // our data points must also use the Chinese names (e.g. "ä¸­å›½å¤§é™†") to match the map regions.
            const mapData = data.data.map(item => {
                const name = countryMap[item.Key] || codeToMapName[item.Key] || item.Key;
                return {
                    name: name,
                    value: item.Value
                };
            });

            const maxVal = mapData.length > 0 ? Math.max(...mapData.map(item => item.value)) : 0;

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function (params) {
                        const val = params.value;
                        return `${params.name}<br/>è¯·æ±‚æ•°: ${val ? val.toLocaleString() : 0} æ¬¡`;
                    }
                },
                visualMap: {
                    min: 0,
                    max: maxVal,
                    left: 'left',
                    top: 'bottom',
                    text: ['High', 'Low'],
                    calculable: true,
                    inRange: {
                        color: ['#e0f2fe', '#0284c7']
                    },
                    textStyle: { color: document.documentElement.classList.contains('dark') ? '#e5e7eb' : '#333' }
                },
                series: [
                    {
                        name: 'è¯·æ±‚æ•°',
                        type: 'map',
                        mapType: 'world',
                        roam: true,
                        nameMap: worldNameMap,
                        itemStyle: {
                            emphasis: { label: { show: true } }
                        },
                        data: mapData
                    }
                ]
            };

            chartTopMap.setOption(option);
        }

        //6.æœ‰ä½¿ç”¨
        function updateTopAnalysisSection(results) {
            updateTopMapChart(results);

            // Flux Charts
            renderTopChart(results, chartTopCountry, 'l7Flow_outFlux_country', countryMap);
            renderTopChart(results, chartTopProvince, 'l7Flow_outFlux_province', provinceMap);
            renderTopChart(results, chartTopStatusCode, 'l7Flow_outFlux_statusCode');
            renderTopChart(results, chartTopDomain, 'l7Flow_outFlux_domain');
            renderTopChart(results, chartTopUrl, 'l7Flow_outFlux_url');
            renderTopChart(results, chartTopResourceType, 'l7Flow_outFlux_resourceType');
            renderTopChart(results, chartTopSip, 'l7Flow_outFlux_sip');
            //renderTopChart(results, chartTopReferer, 'l7Flow_outFlux_referers'); //ä»¥å‰æ–¹æ¡ˆ
            updateTopRefererChart(results); //é™çº§å¤„ç†ï¼ŒåŒ…å«â€œå­—æ®µä¸å­˜åœ¨â€å¤„ç†
            renderTopChart(results, chartTopUaDevice, 'l7Flow_outFlux_ua_device');
            renderTopChart(results, chartTopUaBrowser, 'l7Flow_outFlux_ua_browser');
            renderTopChart(results, chartTopUaOs, 'l7Flow_outFlux_ua_os');
            renderTopChart(results, chartTopUa, 'l7Flow_outFlux_ua');

            // Request Charts
            renderTopChart(results, chartTopRequestCountry, 'l7Flow_request_country', countryMap);
            renderTopChart(results, chartTopRequestProvince, 'l7Flow_request_province', provinceMap);
            renderTopChart(results, chartTopRequestStatusCode, 'l7Flow_request_statusCode');
            renderTopChart(results, chartTopRequestDomain, 'l7Flow_request_domain');
            renderTopChart(results, chartTopRequestUrl, 'l7Flow_request_url');
            renderTopChart(results, chartTopRequestResourceType, 'l7Flow_request_resourceType');
            renderTopChart(results, chartTopRequestSip, 'l7Flow_request_sip');
            //renderTopChart(results, chartTopRequestReferer, 'l7Flow_request_referers');
            updateTopRequestRefererChart(results); //é™çº§æ–¹æ¡ˆ
            renderTopChart(results, chartTopRequestUaDevice, 'l7Flow_request_ua_device');
            renderTopChart(results, chartTopRequestUaBrowser, 'l7Flow_request_ua_browser');
            renderTopChart(results, chartTopRequestUaOs, 'l7Flow_request_ua_os');
            renderTopChart(results, chartTopRequestUa, 'l7Flow_request_ua');
        }



        /**  
         *  ä¸‹é¢è¿™ä¸€å †æˆ‘ä¹Ÿä¸çŸ¥é“æ˜¯å¹²å˜›çš„
         *  å¯èƒ½æ˜¯äºŒå‰è„†è„†é—ç•™ä¸‹çš„é™çº§æ–¹æ¡ˆå§
         *  å…ˆä¸åˆ äº†ï¼Œçœçš„å†å‡ºé—®é¢˜
         *  ä¸è¿‡å€’æ˜¯å¯ä»¥å…ˆç•™ç€ä¹Ÿæ˜¯ï¼Œè¯´ä¸å®šåé¢å¯èƒ½ä¼šç”¨åˆ°ï¼Ÿ
         *  çœŸçš„å¤ªç¥ç§˜äº†
         * **/

        function updateTopRefererChart(results) {
            const metric = 'l7Flow_outFlux_referers';
            const data = results[metric];
            const isDark = document.documentElement.classList.contains('dark');

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => {
                // Clean up key: remove backticks and trim
                let key = item.Key.replace(/`/g, '').trim();
                if (!key || key === '-') return 'å­—æ®µä¸å­˜åœ¨'; //æ— /ç›´æ¥è®¿é—®
                return key;
            }).reverse();
            
            const seriesData = sortedData.map(item => (item.Value / (1024 * 1024 * 1024)).toFixed(2)).reverse(); // GB

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         return `${param.name}<br/>${param.marker}æµé‡: ${param.value} GB`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'GB', axisLabel: { color: isDark ? '#e5e7eb' : '#6E7079' } },
                yAxis: { 
                    type: 'category', 
                    data: yAxisData,
                    axisLabel: {
                        color: isDark ? '#e5e7eb' : '#6E7079',
                        formatter: function (value) {
                            // Truncate long URLs
                            if (value.length > 30) {
                                return value.substring(0, 30) + '...';
                            }
                            return value;
                        }
                    }
                },
                series: [
                    {
                        name: 'æµé‡',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#8b5cf6' }, // Purple
                        label: { show: true, position: 'right', color: isDark ? '#e5e7eb' : '#111827' }
                    }
                ]
            };

            chartTopReferer.setOption(option);
        }

        function updateTopRequestRefererChart(results) {
            const metric = 'l7Flow_request_referers';
            const data = results[metric];
            const isDark = document.documentElement.classList.contains('dark');

            if (!data || data.type !== 'top' || !data.data) return;

            // Sort by value (descending)
            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10); // Top 10

            const yAxisData = sortedData.map(item => {
                 let key = item.Key;
                 if (key === '-') return 'å­—æ®µä¸å­˜åœ¨'; //ç›´æ¥è®¿é—®
                 // Clean up backticks and extra spaces
                 key = key.replace(/`/g, '').trim();
                 return key.substring(0, 50) + (key.length > 50 ? '...' : '');
            }).reverse();
            const seriesData = sortedData.map(item => item.Value).reverse();

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         // Find full referer string
                         const originalItem = sortedData.find((item, index) => index === (sortedData.length - 1 - param.dataIndex));
                         let fullName = param.name;
                         if (originalItem) {
                             let key = originalItem.Key;
                             if (key === '-') fullName = 'å­—æ®µä¸å­˜åœ¨'; //ç›´æ¥è®¿é—®
                             else fullName = key.replace(/`/g, '').trim();
                         }
                         return `${fullName}<br/>${param.marker}è¯·æ±‚æ•°: ${param.value.toLocaleString()} æ¬¡`;
                    }
                },
                grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: 'æ¬¡', axisLabel: { color: isDark ? '#e5e7eb' : '#6E7079' } },
                yAxis: { type: 'category', data: yAxisData, axisLabel: { interval: 0, width: 200, overflow: 'truncate', color: isDark ? '#e5e7eb' : '#6E7079' } },
                series: [
                    {
                        name: 'è¯·æ±‚æ•°',
                        type: 'bar',
                        data: seriesData,
                        itemStyle: { color: '#ec4899' },
                        label: { show: true, position: 'right', color: isDark ? '#e5e7eb' : '#111827' }
                    }
                ]
            };

            chartTopRequestReferer.setOption(option);
        }
        /** ç¥ç§˜é™çº§æ–¹æ¡ˆç»“æŸ **/

        // Handle Resize
        window.addEventListener('resize', () => {
            chartTraffic && chartTraffic.resize();
            chartBandwidth && chartBandwidth.resize();
            chartRequests && chartRequests.resize();
            chartPerformance && chartPerformance.resize();
            chartOriginPull && chartOriginPull.resize();
            chartTopCountry && chartTopCountry.resize();
            chartTopProvince && chartTopProvince.resize();
            chartTopStatusCode && chartTopStatusCode.resize();
            chartTopDomain && chartTopDomain.resize();
            chartTopUrl && chartTopUrl.resize();
            chartTopResourceType && chartTopResourceType.resize();
            chartTopSip && chartTopSip.resize();
            chartTopReferer && chartTopReferer.resize();
            chartTopUaDevice && chartTopUaDevice.resize();
            chartTopUaBrowser && chartTopUaBrowser.resize();
            chartTopUaOs && chartTopUaOs.resize();
            chartTopUa && chartTopUa.resize();
            chartTopRequestCountry && chartTopRequestCountry.resize();
            chartTopRequestProvince && chartTopRequestProvince.resize();
            chartTopRequestStatusCode && chartTopRequestStatusCode.resize();
            chartTopRequestDomain && chartTopRequestDomain.resize();
            chartTopRequestUrl && chartTopRequestUrl.resize();
            chartTopRequestResourceType && chartTopRequestResourceType.resize();
            chartTopRequestSip && chartTopRequestSip.resize();
            chartTopRequestReferer && chartTopRequestReferer.resize();
            chartTopRequestUaDevice && chartTopRequestUaDevice.resize();
            chartTopRequestUaBrowser && chartTopRequestUaBrowser.resize();
            chartTopRequestUaOs && chartTopRequestUaOs.resize();
            chartTopRequestUa && chartTopRequestUa.resize();
            chartTopMap && chartTopMap.resize();
            chartFunctionRequests && chartFunctionRequests.resize();
            chartFunctionCpu && chartFunctionCpu.resize();
            chartPagesCloudFunctionRequests && chartPagesCloudFunctionRequests.resize();
        });

        // ğŸŒ™ å¤œé—´æ¨¡å¼é€»è¾‘
        function applyTheme(theme) {
            const html = document.documentElement;
            const btn = document.getElementById('themeToggle');

            // å®šä¹‰ SVG å›¾æ ‡å˜é‡ï¼Œæ·»åŠ  class="w-4 h-4 mr-2" ä»¥ä¾¿ä¸æ–‡å­—å¯¹é½
            // å¤ªé˜³å›¾æ ‡ (åˆ‡æ¢åˆ°æ—¥é—´æ¨¡å¼)
            const sunIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun h-4 w-4"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>';
            
            
            const moonIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon h-4 w-4"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>';

            if (theme === 'dark') {
                html.classList.add('dark');
                // å¤œé—´æ¨¡å¼ä¸‹ï¼šæ˜¾ç¤ºå¤ªé˜³å›¾æ ‡ï¼Œç‚¹å‡»åˆ‡æ¢åˆ°æ—¥é—´æ¨¡å¼
                btn.innerHTML = `${sunIcon}`;
            } else {
                html.classList.remove('dark');
                // æ—¥é—´æ¨¡å¼ä¸‹ï¼šæ˜¾ç¤ºæœˆäº®å›¾æ ‡ï¼Œç‚¹å‡»åˆ‡æ¢åˆ°å¤œé—´æ¨¡å¼
                btn.innerHTML = `${moonIcon}`;
            }

            localStorage.setItem('theme', theme);

            // åˆ·æ–° ECharts ä¸»é¢˜ï¼ˆæˆ–é‡ç»˜å›¾è¡¨ä»¥é€‚åº”æ·±è‰²èƒŒæ™¯å˜åŒ–ï¼‰
            setTimeout(() => {
               rerenderChartsByTheme();
            }, 50);
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            applyTheme(isDark ? 'light' : 'dark');
        }

        function rerenderChartsByTheme() {
          if (!lastResults) return;

          // Call all relevant update functions to re-apply ECharts options with theme-aware colors.
          updateTrafficSection(lastResults);
          updateBandwidthSection(lastResults);
          updateOriginPullSection(lastResults);
          updateRequestsSection(lastResults);
          updatePerformanceSection(lastResults);
          updateEdgeFunctionsSection(lastResults);
          updateSecuritySection(lastResults);
          updateTopAnalysisSection(lastResults);
          
          // Pages charts are updated separately or need their own re-render logic if they use stored data
          // For now, we mainly refresh the main dashboard charts.
          // Since Pages charts fetch data independently and don't store in `lastResults`, 
          // we could re-trigger their fetch or just update options if we stored data.
          // To keep it simple and fast, we skip re-fetching pages stats for theme toggle unless implemented.
        }

        // åˆå§‹åŒ–ä¸»é¢˜
        (function initTheme() {
            const saved = localStorage.getItem('theme');
            if (saved) {
                applyTheme(saved);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            }
        })();

        // Start - Entrance
        initDashboard();
    </script>
</body>
</html>
```