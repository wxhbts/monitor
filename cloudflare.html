<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" href="https://cdn.cydiaa.com/favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudflare ç›‘æ§å¤§å±</title>
    <script>
        // ç«‹å³æ‰§è¡Œï¼Œæ£€æŸ¥æœ¬åœ°å­˜å‚¨æˆ–ç³»ç»Ÿåå¥½
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <!-- Tailwind CSS -->
    <script src="https://eo.cydiaa.com/?url=https://cdn.tailwindcss.com"></script>
    <script src="https://eo.cydiaa.com/?url=https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://eo.cydiaa.com/?url=https://cdn.jsdelivr.net/npm/echarts@4.9.0/map/js/world.js"></script>
    <style>
        @import url('https://eo.cydiaa.com/?url=https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        border: "hsl(var(--border))",
                        input: "hsl(var(--input))",
                        ring: "hsl(var(--ring))",
                        background: "hsl(var(--background))",
                        foreground: "hsl(var(--foreground))",
                        primary: { DEFAULT: "hsl(var(--primary))", foreground: "hsl(var(--primary-foreground))" },
                        secondary: { DEFAULT: "hsl(var(--secondary))", foreground: "hsl(var(--secondary-foreground))" },
                        destructive: { DEFAULT: "hsl(var(--destructive))", foreground: "hsl(var(--destructive-foreground))" },
                        muted: { DEFAULT: "hsl(var(--muted))", foreground: "hsl(var(--muted-foreground))" },
                        accent: { DEFAULT: "hsl(var(--accent))", foreground: "hsl(var(--accent-foreground))" },
                        popover: { DEFAULT: "hsl(var(--popover))", foreground: "hsl(var(--popover-foreground))" },
                        card: { DEFAULT: "hsl(var(--card))", foreground: "hsl(var(--card-foreground))" },
                    },
                    borderRadius: { lg: "var(--radius)", md: "calc(var(--radius) - 2px)", sm: "calc(var(--radius) - 4px)" },
                },
            },
        }
    </script>
    <style>
:root {
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;
    --card: 0 0% 100%;
    --card-foreground: 222.2 84% 4.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 222.2 84% 4.9%;
    --primary: 222.2 47.4% 11.2%;
    --primary-foreground: 210 40% 98%;
    --secondary: 210 40% 96.1%;
    --secondary-foreground: 222.2 47.4% 11.2%;
    --muted: 210 40% 96.1%;
    --muted-foreground: 215.4 16.3% 46.9%;
    --accent: 210 40% 96.1%;
    --accent-foreground: 222.2 47.4% 11.2%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 210 40% 98%;
    --border: 214.3 31.8% 91.4%;
    --input: 214.3 31.8% 91.4%;
    --ring: 222.2 84% 4.9%;
	--radius: 0.75rem;
}

/* ğŸŒ™ å¤œé—´æ¨¡å¼ */
html.dark {
    --background: 240 10% 3.9%;
    --foreground: 0 0% 98%;
    --card: 240 10% 3.9%;
    --card-foreground: 0 0% 98%;
    --popover: 240 10% 3.9%;
    --popover-foreground: 0 0% 98%;
    --primary: 212 100% 68%;
    --primary-foreground: 0 0% 9%;
    --secondary: 240 3.7% 15.9%;
    --secondary-foreground: 0 0% 98%;
    --muted: 240 3.7% 15.9%;
    --muted-foreground: 0 0% 63.9%;
    --accent: 240 3.7% 15.9%;
    --accent-foreground: 0 0% 98%;
    --destructive: 0 62.8% 30.6%;
    --destructive-foreground: 0 0% 98%;
    --border: 240 3.7% 15.9%;
    --input: 240 3.7% 15.9%;
    --ring: 212 100% 68%;
    --chart-1: 212 100% 68%;
    --chart-2: 0 0% 50%;
    --chart-3: 30 80% 55%;
    --chart-4: 280 65% 60%;
    --chart-5: 340 75% 55%;
    --radius: 0.75rem;
    --sidebar-background: 240 5.9% 10%;
    --sidebar-foreground: 240 4.8% 95.9%;
    --sidebar-primary: 224.3 76.3% 48%;
    --sidebar-primary-foreground: 0 0% 100%;
    --sidebar-accent: 240 3.7% 15.9%;
    --sidebar-accent-foreground: 240 4.8% 95.9%;
    --sidebar-border: 240 3.7% 15.9%;
    --sidebar-ring: 217.2 91.2% 59.8%;

	*, ::after, ::before {
  border-color: hsl(var(--border));
}}
</style>

</head>
<body class="bg-background text-foreground min-h-screen p-8 transition-colors">

    <!-- Loading Progress Bar -->
    <div id="loading-progress-container-2" class="fixed top-0 left-0 w-full h-1 z-50 bg-transparent pointer-events-none">
        <div id="loading-progress-bar-2" class="h-full bg-blue-500 transition-all duration-300 ease-out w-0"></div>
    </div>
    <div class="max-w-7xl mx-auto space-y-8">
        
        <!-- Header -->
        <div class="flex items-center justify-between">
    <div>
        <h1 id="page-header" class="text-3xl font-bold tracking-tight text-foreground">
            Cloudflare ç›‘æ§å¤§å±
        </h1>
        <p class="text-muted-foreground mt-1">
            Cloudflare ç«™ç‚¹æµé‡ä¸è¯·æ±‚é‡åˆ†æ
        </p>
    </div>

    <!-- ğŸŒ™ å¤œé—´æ¨¡å¼æŒ‰é’® -->
    <button
        id="themeToggle"
        onclick="toggleTheme()"
        class="h-9 px-4 rounded-md border bg-card text-card-foreground hover:bg-accent transition text-sm cursor-pointer"
    >
        ğŸŒ™ å¤œé—´æ¨¡å¼
    </button>
</div>


        <!-- Time Controls -->
        <div class="flex flex-wrap items-center gap-4 bg-card p-4 rounded-xl border border-border shadow-sm transition-colors">

            <div class="flex items-center space-x-2">
                <label for="timeRange" class="text-sm font-medium text-foreground">æ—¶é—´èŒƒå›´:</label>
                <select id="timeRange" onchange="handleTimeRangeChange()" class="h-9 w-[180px] rounded-md
         rounded-md border border-border
         bg-background text-foreground
         px-3 py-1 text-sm shadow-sm
         transition-colors
         focus-visible:outline-none
         focus-visible:ring-1
         focus-visible:ring-ring">
                    <option value="3h">è¿‘ 3 å°æ—¶</option>
                    <option value="6h">è¿‘ 6 å°æ—¶</option>
                    <option value="today">ä»Šæ—¥</option>
                    <option value="yesterday">æ˜¨æ—¥</option>
                    <option value="3d">è¿‘ 3 å¤©</option>
                    <option value="7d">è¿‘ 7 å¤©</option>
                    <option value="14d">è¿‘ 14 å¤©</option>
                    <option value="31d">è¿‘ 31 å¤©</option>
                    <option value="182d">è¿‘ åŠ å¹´</option>
                    <option value="365d">è¿‘ 1 å¹´</option>
					<option value="custom">è‡ªå®šä¹‰</option>
                </select>
            </div>
            <!-- Custom Time Inputs -->
            <div id="customTimeInputs" class="hidden flex-wrap items-center gap-2 mt-2 w-full sm:w-auto">
                <div class="flex items-center space-x-1">
                    <input type="number" id="customDays" placeholder="0" class="h-8 w-16 rounded-md border border-slate-200 px-2 text-sm dark:bg-slate-800 dark:border-slate-700 dark:text-slate-200" min="0" max="31">
                    <span class="text-xs">å¤©</span>
                </div>
                <div class="flex items-center space-x-1">
                    <input type="number" id="customHours" placeholder="0" class="h-8 w-16 rounded-md border border-slate-200 px-2 text-sm dark:bg-slate-800 dark:border-slate-700 dark:text-slate-200" min="0" max="23">
                    <span class="text-xs">å°æ—¶</span>
                </div>
                <div class="flex items-center space-x-1">
                    <input type="number" id="customMinutes" placeholder="0" class="h-8 w-16 rounded-md border border-slate-200 px-2 text-sm dark:bg-slate-800 dark:border-slate-700 dark:text-slate-200" min="0" max="59">
                    <span class="text-xs">åˆ†</span>
                </div>
                <div class="flex items-center space-x-1">
                    <input type="number" id="customSeconds" placeholder="0" class="h-8 w-16 rounded-md border border-slate-200 px-2 text-sm dark:bg-slate-800 dark:border-slate-700 dark:text-slate-200" min="0" max="59">
                    <span class="text-xs">ç§’</span>
                </div>
                <button onclick="refreshData()" class="h-8 px-3 bg-slate-900 text-white rounded-md text-xs hover:bg-slate-800 cursor-pointer border border-slate-700">åº”ç”¨</button>
                <span id="timeRangeError" class="text-red-500 text-xs font-medium ml-2"></span>
            </div>
            <div class="flex items-center space-x-2">
                <label for="interval" class="text-sm font-medium">ç²’åº¦:</label>
                <select id="interval" onchange="refreshData()" class="h-9 w-[180px] rounded-md
         rounded-md border border-border
         bg-background text-foreground
         px-3 py-1 text-sm shadow-sm
         transition-colors
         focus-visible:outline-none
         focus-visible:ring-1
         focus-visible:ring-ring">
                    <option value="auto" selected>è‡ªåŠ¨</option>
                    <option value="60">1 åˆ†é’Ÿ</option>
                    <option value="300">5 åˆ†é’Ÿ</option>
                    <option value="3600">1 å°æ—¶</option>
                    <option value="86400">1 å¤©</option>
                </select>
            </div>
            <div class="flex items-center space-x-2">
                <label for="cdnSelector" class="text-sm font-medium">CDNæœåŠ¡å•†:</label>
                <select id="cdnSelector" onchange="if(this.value) window.location.href=this.value" class="h-9 w-[180px] rounded-md
         rounded-md border border-border
         bg-background text-foreground
         px-3 py-1 text-sm shadow-sm
         transition-colors
         focus-visible:outline-none
         focus-visible:ring-1
         focus-visible:ring-ring">
                    <option value="index.html">è…¾è®¯äº‘ EO ç›‘æ§</option>
                    <option value="aliesa.html">é˜¿é‡Œäº‘ ESA ç›‘æ§</option>
                    <option value="cloudflare.html" selected>Cloudflare ç›‘æ§</option>
                </select>
            </div>
        </div>

        <!-- Main Content -->
        <div class="space-y-8">

            <!-- Section 1: Traffic (æµé‡) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-foreground flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    æµé‡åˆ†æ (Traffic)
                </h2>
                <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-4">
                    <!-- Total Traffic Card -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">æ€»æµé‡</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_flux">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">è®¿é—®æ€»æµé‡</p>
                        </div>
                    </div>
                    <!-- Client Request Traffic -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">ç¼“å­˜è¯·æ±‚æ•°</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_cachedRequests">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">ç¼“å­˜è¯·æ±‚æ¬¡æ•°</p>
                        </div>
                    </div>
                    <!-- Response Traffic -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">ç¼“å­˜æµé‡</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_outFlux">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">Cloudflare å“åº”æµé‡</p>
                        </div>
                    </div>
					<!-- Cache Hit Rate -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">ç¼“å­˜å‘½ä¸­ç‡</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_cache_hit_rate">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">(æºç«™å“åº” / Cloudflare å“åº”)</p>
                        </div>
                    </div>
                </div>
                <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-1">
                    <!-- Traffic Chart -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">æµé‡è¶‹åŠ¿</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_traffic" class="w-full h-[350px]"></div>
                        </div>
                    </div>
                </div>
            </div>
			 <!-- Section 4: Requests & Performance (è¯·æ±‚ä¸æ€§èƒ½) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-foreground flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    è¯·æ±‚åˆ†æ (Requests)
                </h2>
                <div class="grid gap-4 md:grid-cols-3 lg:grid-cols-3">
                    <!-- Total Requests -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">æ€»è¯·æ±‚æ•°</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_request">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">æ€»è¯·æ±‚æ¬¡æ•°</p>
                        </div>
                    </div>
                    <!-- Avg Response Time -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">æ€»é˜²æŠ¤å‘½ä¸­æ¬¡æ•°</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_outcc">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">é˜²æŠ¤æ€»æ‹¦æˆªæ¬¡æ•°</p>
                        </div>
                    </div>
                    <!-- Avg First Byte Time -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">é¡µé¢æµè§ˆé‡</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_l7Flow_inFlux">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">é¡µé¢è¯·æ±‚æ¬¡æ•°</p>
                        </div>
                    </div>
                </div>
                <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-1">
                    <!-- Requests Chart -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">è¯·æ±‚æ•°è¶‹åŠ¿</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_requests" class="w-full h-[350px]"></div>
                        </div>
                    </div>
            </div>
			<!-- Section: Edge Functions (è¾¹ç¼˜å‡½æ•°) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-foreground flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg>
                    è¾¹ç¼˜å‡½æ•° (Cloudflare workers-and-pages)
                </h2>
                <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-2">
                    <!-- Function Requests -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">æ€»è¯·æ±‚æ•°</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_function_requestCount">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">Cloudflare workers æ€»è°ƒç”¨æ¬¡æ•°</p>
                        </div>
                    </div>
                    <!-- Function CPU Time -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="p-6 flex flex-row items-center justify-between space-y-0 pb-2">
                            <h3 class="tracking-tight text-sm font-medium text-muted-foreground">æ€» CPU æ—¶é—´</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div class="text-2xl font-bold" id="kpi_function_cpuCostTime">åŠ è½½ä¸­...</div>
                            <p class="text-xs text-muted-foreground mt-1">Cloudflare workers æ€» CPU è€—æ—¶ (ms)</p>
                        </div>
                    </div>
                </div>
                <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-2">
                    <!-- Function Requests Chart -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å‡½æ•°è¯·æ±‚æ•°è¶‹åŠ¿</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_function_requests" class="w-full h-[350px]"></div>
                        </div>
                    </div>
                    <!-- Function CPU Chart -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å‡½æ•° CPU è€—æ—¶è¶‹åŠ¿</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_function_cpu" class="w-full h-[350px]"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Section 6: Top Analysis (TOP åˆ†æ) -->
            <div class="space-y-4">
                <h2 class="text-xl font-bold tracking-tight text-foreground flex items-center gap-2">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
                    TOP åˆ†æ (Top Analysis)
                </h2>
                <!-- World Map -->
                <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                    <div class="flex flex-col space-y-1.5 p-6">
                        <h3 class="font-semibold leading-none tracking-tight">å…¨çƒè¯·æ±‚åˆ†å¸ƒ</h3>
                    </div>
                    <div class="p-6 pt-0">
                        <div id="chart_top_map" class="w-full h-[500px]"></div>
                    </div>
                </div>
                
                <div class="grid gap-4 md:grid-cols-2">
                    <!-- Country -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å›½å®¶/åœ°åŒºæµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_country" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å›½å®¶/åœ°åŒºè¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_country" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <!-- Domain -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">åŸŸåæµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_domain" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">åŸŸåè¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_domain" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                     <!-- Resource Type -->
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">èµ„æºç±»å‹æµé‡æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_resource_type" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                    <div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">èµ„æºç±»å‹è¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_resource_type" class="w-full h-[500px]"></div>
                        </div>
                    </div>
					<div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å®¢æˆ·ç«¯IPè¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_sip" class="w-full h-[500px]"></div>
                        </div>
                    </div>
					<div class="rounded-xl border bg-card text-card-foreground shadow-sm">
                        <div class="flex flex-col space-y-1.5 p-6">
                            <h3 class="font-semibold leading-none tracking-tight">å­åŸŸåè¯·æ±‚æ•°æ’è¡Œ</h3>
                        </div>
                        <div class="p-6 pt-0">
                            <div id="chart_top_request_zym" class="w-full h-[500px]"></div>
                        </div>
                    </div>
                </div>
            </div>
    </div>

    <script>
        // ECharts instance variables
        let currentAbortController = null; // ç”¨äºæ§åˆ¶è¯·æ±‚å–æ¶ˆ
        let chartTraffic = null;
        let chartRequests = null;
        let chartTopMap = null;
		
		let lastResults = null;
        
        // Flux Top Charts
        let chartTopCountry = null;
        let chartTopDomain = null;
        let chartTopResourceType = null;
		let chartFunctionRequests = null;
        let chartFunctionCpu = null;
        // Request Top Charts
        let chartTopRequestCountry = null;
        let chartTopRequestDomain = null;
        let chartTopRequestResourceType = null;
		let chartTopRequestSip = null;
		let chartTopRequestzym = null;

        const countryMap = {
            'CN': 'ä¸­å›½å¤§é™†', 'AF': 'é˜¿å¯Œæ±—', 'MV': 'é©¬å°”ä»£å¤«', 'AM': 'äºšç¾å°¼äºš', 'MN': 'è’™å¤', 'AZ': 'é˜¿å¡æ‹œç–†',
            'MM': 'ç¼…ç”¸', 'BH': 'å·´æ—', 'NP': 'å°¼æ³Šå°”', 'BD': 'å­ŸåŠ æ‹‰', 'KP': 'æœé²œ',
            'BT': 'ä¸ä¸¹', 'OM': 'é˜¿æ›¼', 'IO': 'è‹±å±å°åº¦æ´‹é¢†åœ°', 'PK': 'å·´åŸºæ–¯å¦', 'KH': 'æŸ¬åŸ”å¯¨',
            'PS': 'å·´å‹’æ–¯å¦', 'CX': 'åœ£è¯å²›', 'PH': 'è²å¾‹å®¾', 'HK': 'ä¸­å›½é¦™æ¸¯', 'QA': 'å¡å¡”å°”',
            'IN': 'å°åº¦', 'SA': 'æ²™ç‰¹é˜¿æ‹‰ä¼¯', 'ID': 'å°åº¦å°¼è¥¿äºš', 'SG': 'æ–°åŠ å¡', 'IR': 'ä¼Šæœ—',
            'KR': 'éŸ©å›½', 'IQ': 'ä¼Šæ‹‰å…‹', 'LK': 'æ–¯é‡Œå…°å¡', 'IL': 'ä»¥è‰²åˆ—', 'SY': 'å™åˆ©äºš',
            'JP': 'æ—¥æœ¬', 'TW': 'ä¸­å›½å°æ¹¾', 'JO': 'çº¦æ—¦', 'TJ': 'å¡”å‰å…‹æ–¯å¦', 'KZ': 'å“ˆè¨å…‹æ–¯å¦',
            'TH': 'æ³°å›½', 'KW': 'ç§‘å¨ç‰¹', 'TM': 'åœŸåº“æ›¼æ–¯å¦', 'KG': 'å‰å°”å‰æ–¯æ–¯å¦', 'AE': 'é˜¿è”é…‹',
            'LA': 'è€æŒ', 'UZ': 'ä¹Œå…¹åˆ«å…‹æ–¯å¦', 'LB': 'é»å·´å«©', 'VN': 'è¶Šå—', 'MO': 'ä¸­å›½æ¾³é—¨',
            'YE': 'ä¹Ÿé—¨', 'MY': 'é©¬æ¥è¥¿äºš', 'TR': 'åœŸè€³å…¶', 'AX': 'å¥¥å…°ç¾¤å²›', 'IT': 'æ„å¤§åˆ©',
            'AL': 'é˜¿å°”å·´å°¼äºš', 'JE': 'æ³½è¥¿å²›', 'AD': 'å®‰é“å°”', 'LT': 'ç«‹é™¶å®›', 'AT': 'å¥¥åœ°åˆ©',
            'LU': 'å¢æ£®å ¡', 'BY': 'ç™½ä¿„ç½—æ–¯', 'MK': 'é©¬å…¶é¡¿', 'BE': 'æ¯”åˆ©æ—¶', 'MT': 'é©¬è€³ä»–',
            'BA': 'æ³¢é»‘', 'MD': 'æ‘©å°”å¤šç“¦', 'BG': 'ä¿åŠ åˆ©äºš', 'MC': 'æ‘©çº³å“¥', 'BQ': 'è·å…°åŠ å‹’æ¯”åŒº',
            'ME': 'é»‘å±±', 'HR': 'å…‹ç½—åœ°äºš', 'NL': 'è·å…°', 'CZ': 'æ·å…‹', 'NO': 'æŒªå¨',
            'DK': 'ä¸¹éº¦', 'PL': 'æ³¢å…°', 'EE': 'çˆ±æ²™å°¼äºš', 'PT': 'è‘¡è„ç‰™', 'FO': 'æ³•ç½—ç¾¤å²›',
            'RO': 'ç½—é©¬å°¼äºš', 'FI': 'èŠ¬å…°', 'RU': 'ä¿„ç½—æ–¯', 'FR': 'æ³•å›½', 'SM': 'åœ£é©¬åŠ›è¯º',
            'DE': 'å¾·å›½', 'RS': 'å¡å°”ç»´äºš', 'GI': 'ç›´å¸ƒç½—é™€', 'SX': 'è·å±åœ£é©¬ä¸', 'GR': 'å¸Œè…Š',
            'SK': 'æ–¯æ´›ä¼å…‹', 'GG': 'æ ¹è¥¿å²›', 'ES': 'è¥¿ç­ç‰™', 'HU': 'åŒˆç‰™åˆ©', 'SE': 'ç‘å…¸',
            'IS': 'å†°å²›', 'CH': 'ç‘å£«', 'IE': 'çˆ±å°”å…°', 'UA': 'ä¹Œå…‹å…°', 'IM': 'é©¬æ©å²›',
            'GB': 'è‹±å›½', 'DZ': 'é˜¿å°”åŠåˆ©äºš', 'ML': 'é©¬é‡Œ', 'AO': 'å®‰å“¥æ‹‰', 'MR': 'æ¯›é‡Œå¡”å°¼äºš',
            'BJ': 'è´å®', 'MU': 'æ¯›é‡Œæ±‚æ–¯', 'BW': 'åšèŒ¨ç“¦çº³', 'YT': 'é©¬çº¦ç‰¹', 'BF': 'å¸ƒåŸºçº³æ³•ç´¢',
            'MA': 'æ‘©æ´›å“¥', 'BI': 'å¸ƒéš†è¿ª', 'MZ': 'è«æ¡‘æ¯”å…‹', 'CM': 'å–€éº¦éš†', 'NA': 'çº³ç±³æ¯”äºš',
            'CV': 'ä½›å¾—è§’', 'NE': 'å°¼æ—¥å°”', 'CF': 'ä¸­é', 'NG': 'å°¼æ—¥åˆ©äºš', 'TD': 'ä¹å¾—',
            'RW': 'å¢æ—ºè¾¾', 'KM': 'ç§‘æ‘©ç½—', 'SH': 'åœ£èµ«å‹’æ‹¿', 'DJ': 'å‰å¸ƒæ', 'ST': 'åœ£å¤šç¾å’Œæ™®æ—è¥¿æ¯”',
            'EG': 'åŸƒåŠ', 'SN': 'å¡å†…åŠ å°”', 'GQ': 'èµ¤é“å‡ å†…äºš', 'SC': 'å¡èˆŒå°”', 'ER': 'å„ç«‹ç‰¹é‡Œäºš',
            'SL': 'å¡æ‹‰åˆ©æ˜‚', 'ET': 'åŸƒå¡ä¿„æ¯”äºš', 'SO': 'ç´¢é©¬é‡Œ', 'GA': 'åŠ è“¬', 'ZA': 'å—é',
            'GM': 'å†ˆæ¯”äºš', 'SS': 'å—è‹ä¸¹', 'GH': 'åŠ çº³', 'SD': 'è‹ä¸¹', 'GN': 'å‡ å†…äºš',
            'SZ': 'æ–¯å¨å£«å…°', 'GW': 'å‡ å†…äºšæ¯”ç»', 'TZ': 'å¦æ¡‘å°¼äºš', 'KE': 'è‚¯å°¼äºš', 'TG': 'å¤šå“¥',
            'LS': 'è±ç´¢æ‰˜', 'TN': 'çªå°¼æ–¯', 'LR': 'åˆ©æ¯”é‡Œäºš', 'UG': 'ä¹Œå¹²è¾¾', 'LY': 'åˆ©æ¯”äºš',
            'EH': 'è¥¿æ’’å“ˆæ‹‰', 'MG': 'é©¬è¾¾åŠ æ–¯åŠ ', 'ZM': 'èµæ¯”äºš', 'MW': 'é©¬æ‹‰ç»´', 'ZW': 'æ´¥å·´å¸ƒéŸ¦',
            'CD': 'åˆšæœæ°‘ä¸»å…±å’Œå›½', 'CG': 'åˆšæœå…±å’Œå›½', 'CI': 'ç§‘ç‰¹è¿ªç“¦', 'AU': 'æ¾³å¤§åˆ©äºš', 'NF': 'è¯ºç¦å…‹å²›',
            'CK': 'åº“å…‹ç¾¤å²›', 'MP': 'åŒ—é©¬é‡Œäºšçº³ç¾¤å²›', 'TL': 'ä¸œå¸æ±¶', 'PW': 'å¸•åŠ³', 'GU': 'å…³å²›',
            'PG': 'å·´å¸ƒäºšæ–°å‡ å†…äºš', 'KI': 'åŸºé‡Œå·´æ–¯', 'SB': 'æ‰€ç½—é—¨ç¾¤å²›', 'MH': 'é©¬ç»å°”ç¾¤å²›', 'TO': 'æ±¤åŠ ',
            'NR': 'ç‘™é²', 'TV': 'å›¾ç“¦å¢', 'NZ': 'æ–°è¥¿å…°', 'AI': 'å®‰åœ­æ‹‰', 'HT': 'æµ·åœ°',
            'AG': 'å®‰æç“œå’Œå·´å¸ƒè¾¾', 'HN': 'æ´ªéƒ½æ‹‰æ–¯', 'AW': 'é˜¿é²å·´', 'JM': 'ç‰™ä¹°åŠ ', 'BS': 'å·´å“ˆé©¬',
            'MX': 'å¢¨è¥¿å“¥', 'BB': 'å·´å·´å¤šæ–¯', 'MS': 'è’™å¡æ‹‰ç‰¹å²›', 'BM': 'ç™¾æ…•å¤§', 'NI': 'å°¼åŠ æ‹‰ç“œ',
            'CA': 'åŠ æ‹¿å¤§', 'PA': 'å·´æ‹¿é©¬', 'KY': 'å¼€æ›¼ç¾¤å²›', 'PR': 'æ³¢å¤šé»å„', 'CR': 'å“¥æ–¯è¾¾é»åŠ ',
            'KN': 'åœ£åŸºèŒ¨å’Œå°¼ç»´æ–¯', 'CU': 'å¤å·´', 'LC': 'åœ£å¢è¥¿äºš', 'CW': 'åº“æ‹‰ç´¢', 'MF': 'æ³•å±åœ£é©¬ä¸',
            'SV': 'è¨å°”ç“¦å¤š', 'TT': 'ç‰¹ç«‹å°¼è¾¾å’Œå¤šå·´å“¥', 'GL': 'æ ¼é™µå…°å²›', 'TC': 'ç‰¹å…‹æ–¯å’Œå‡¯ç§‘æ–¯ç¾¤å²›',
            'GD': 'æ ¼æ—çº³è¾¾', 'US': 'ç¾å›½', 'GT': 'å±åœ°é©¬æ‹‰', 'AR': 'é˜¿æ ¹å»·', 'GY': 'åœ­äºšé‚£',
            'BO': 'ç»åˆ©ç»´äºš', 'PY': 'å·´æ‹‰åœ­', 'BR': 'å·´è¥¿', 'PE': 'ç§˜é²', 'CL': 'æ™ºåˆ©',
            'SR': 'è‹é‡Œå—', 'CO': 'å“¥ä¼¦æ¯”äºš', 'UY': 'ä¹Œæ‹‰åœ­', 'EC': 'å„ç“œå¤šå°”', 'VE': 'å§”å†…ç‘æ‹‰',
            'GF': 'æ³•å±åœ­äºšé‚£', 'Antarctica': 'å—ææ´²','FJ':'æ–æµ'
        };

        const codeToMapName = {
            'CN': 'China', 'AF': 'Afghanistan', 'AL': 'Albania', 'DZ': 'Algeria', 'AO': 'Angola', 'AR': 'Argentina',
            'AM': 'Armenia', 'AU': 'Australia', 'AT': 'Austria', 'AZ': 'Azerbaijan', 'BS': 'Bahamas', 'BH': 'Bahrain',
            'BD': 'Bangladesh', 'BB': 'Barbados', 'BY': 'Belarus', 'BE': 'Belgium', 'BZ': 'Belize', 'BJ': 'Benin',
            'BT': 'Bhutan', 'BO': 'Bolivia', 'BA': 'Bosnia and Herzegovina', 'BW': 'Botswana', 'BR': 'Brazil',
            'BN': 'Brunei', 'BG': 'Bulgaria', 'BF': 'Burkina Faso', 'BI': 'Burundi', 'KH': 'Cambodia', 'CM': 'Cameroon',
            'CA': 'Canada', 'CF': 'Central African Republic', 'TD': 'Chad', 'CL': 'Chile', 'CO': 'Colombia',
            'KM': 'Comoros', 'CG': 'Republic of the Congo', 'CD': 'Democratic Republic of the Congo', 'CR': 'Costa Rica',
            'HR': 'Croatia', 'CU': 'Cuba', 'CY': 'Cyprus', 'CZ': 'Czech Republic', 'DK': 'Denmark', 'DJ': 'Djibouti',
            'DO': 'Dominican Republic', 'EC': 'Ecuador', 'EG': 'Egypt', 'SV': 'El Salvador', 'GQ': 'Equatorial Guinea',
            'ER': 'Eritrea', 'EE': 'Estonia', 'ET': 'Ethiopia', 'FJ': 'Fiji', 'FI': 'Finland', 'FR': 'France',
            'GA': 'Gabon', 'GM': 'Gambia', 'GE': 'Georgia', 'DE': 'Germany', 'GH': 'Ghana', 'GR': 'Greece',
            'GT': 'Guatemala', 'GN': 'Guinea', 'GW': 'Guinea-Bissau', 'GY': 'Guyana', 'HT': 'Haiti', 'HN': 'Honduras',
            'HU': 'Hungary', 'IS': 'Iceland', 'IN': 'India', 'ID': 'Indonesia', 'IR': 'Iran', 'IQ': 'Iraq',
            'IE': 'Ireland', 'IL': 'Israel', 'IT': 'Italy', 'CI': 'Ivory Coast', 'JM': 'Jamaica', 'JP': 'Japan',
            'JO': 'Jordan', 'KZ': 'Kazakhstan', 'KE': 'Kenya', 'KP': 'North Korea', 'KR': 'South Korea',
            'KW': 'Kuwait', 'KG': 'Kyrgyzstan', 'LA': 'Laos', 'LV': 'Latvia', 'LB': 'Lebanon', 'LS': 'Lesotho',
            'LR': 'Liberia', 'LY': 'Libya', 'LT': 'Lithuania', 'LU': 'Luxembourg', 'MK': 'Macedonia', 'MG': 'Madagascar',
            'MW': 'Malawi', 'MY': 'Malaysia', 'ML': 'Mali', 'MT': 'Malta', 'MR': 'Mauritania', 'MU': 'Mauritius',
            'MX': 'Mexico', 'MD': 'Moldova', 'MN': 'Mongolia', 'ME': 'Montenegro', 'MA': 'Morocco', 'MZ': 'Mozambique',
            'MM': 'Myanmar', 'NA': 'Namibia', 'NP': 'Nepal', 'NL': 'Netherlands', 'NZ': 'New Zealand', 'NI': 'Nicaragua',
            'NE': 'Niger', 'NG': 'Nigeria', 'NO': 'Norway', 'OM': 'Oman', 'PK': 'Pakistan', 'PA': 'Panama',
            'PG': 'Papua New Guinea', 'PY': 'Paraguay', 'PE': 'Peru', 'PH': 'Philippines', 'PL': 'Poland',
            'PT': 'Portugal', 'PR': 'Puerto Rico', 'QA': 'Qatar', 'RO': 'Romania', 'RU': 'Russia', 'RW': 'Rwanda',
            'SA': 'Saudi Arabia', 'SN': 'Senegal', 'RS': 'Serbia', 'SL': 'Sierra Leone', 'SG': 'Singapore',
            'SK': 'Slovakia', 'SI': 'Slovenia', 'SB': 'Solomon Islands', 'SO': 'Somalia', 'ZA': 'South Africa',
            'SS': 'South Sudan', 'ES': 'Spain', 'LK': 'Sri Lanka', 'SD': 'Sudan', 'SR': 'Suriname', 'SZ': 'Swaziland',
            'SE': 'Sweden', 'CH': 'Switzerland', 'SY': 'Syria', 'TW': 'Taiwan', 'TJ': 'Tajikistan', 'TZ': 'Tanzania',
            'TH': 'Thailand', 'TL': 'Timor-Leste', 'TG': 'Togo', 'TT': 'Trinidad and Tobago', 'TN': 'Tunisia',
            'TR': 'Turkey', 'TM': 'Turkmenistan', 'UG': 'Uganda', 'UA': 'Ukraine', 'AE': 'United Arab Emirates',
            'GB': 'United Kingdom', 'US': 'United States', 'UY': 'Uruguay', 'UZ': 'Uzbekistan', 'VU': 'Vanuatu',
            'VE': 'Venezuela', 'VN': 'Vietnam', 'YE': 'Yemen', 'GL': 'Greenland','ZM': 'Zambia', 'ZW': 'Zimbabwe','LA':'Lao PDR'
        };

        const worldNameMap = {};
        Object.keys(codeToMapName).forEach(code => {
            if (countryMap[code]) {
                worldNameMap[codeToMapName[code]] = countryMap[code];
            }
        });
        
        // Cleaned up metrics config
        const metricsConfig = {
            traffic: ['l7Flow_flux', 'l7Flow_outFlux','l7Flow_cachedRequests'],
            requests: ['l7Flow_request','l7Flow_outcc','l7Flow_inFlux',],
			edgeFunctions: ['function_requestCount', 'function_cpuCostTime'],
            topAnalysis: [
                'l7Flow_outFlux_country', 'l7Flow_request_country',
                'l7Flow_outFlux_domain', 'l7Flow_request_domain',
                'l7Flow_outFlux_resourceType', 'l7Flow_request_resourceType','l7Flow_request_sip','l7Flow_request_zym'
            ]
        };

        const metricLabels = {
            'l7Flow_flux': 'æ€»æµé‡',
            'l7Flow_inFlux': 'é¡µé¢æµè§ˆé‡',
            'l7Flow_outFlux': 'ç¼“å­˜æµé‡',
            'l7Flow_request': 'è¯·æ±‚æ•°',
			'l7Flow_cachedRequests': 'ç¼“å­˜è¯·æ±‚æ•°',
			'l7Flow_outcc': 'é˜²æŠ¤å‘½ä¸­æ•°',
            'l7Flow_outFlux_country': 'å›½å®¶/åœ°åŒºæµé‡',
            'l7Flow_outFlux_domain': 'åŸŸåæµé‡',
            'l7Flow_outFlux_resourceType': 'èµ„æºç±»å‹æµé‡',
            'l7Flow_request_country': 'å›½å®¶/åœ°åŒºè¯·æ±‚æ•°',
            'l7Flow_request_domain': 'åŸŸåè¯·æ±‚æ•°',
			'l7Flow_request_sip': 'å®¢æˆ·ç«¯IPè¯·æ±‚æ•°',
			'l7Flow_request_zym': 'å­åŸŸåè¯·æ±‚æ•°',
            'l7Flow_request_resourceType': 'èµ„æºç±»å‹è¯·æ±‚æ•°',
			'function_requestCount': 'å‡½æ•°è¯·æ±‚æ•°',
            'function_cpuCostTime': 'å‡½æ•°CPUè€—æ—¶'
        };

        const metricColors = {
            'l7Flow_flux': '#3b82f6', // blue
			'l7Flow_outcc': '#10b981', // blue
            'l7Flow_inFlux': '#f59e0b', // amber
            'l7Flow_outFlux': '#10b981', // green
            'l7Flow_request': '#f43f5e', // rose
			'l7Flow_cachedRequests': '#f43f5e', // rose
			'function_requestCount': '#8b5cf6', // purple
            'function_cpuCostTime': '#06b6d4', // cyan
            'l7Flow_outFlux_country': '#3b82f6', // blue
            'l7Flow_outFlux_domain': '#06b6d4', // cyan
            'l7Flow_outFlux_resourceType': '#f59e0b', // amber
            'l7Flow_request_country': '#3b82f6', // blue
            'l7Flow_request_domain': '#06b6d4', // cyan
            'l7Flow_request_resourceType': '#f59e0b', // amber
			'l7Flow_request_sip': '#8b5cf6', // purple
			'l7Flow_request_zym': '#8b5cf6' // purple
        };

        /** Tool Functions **/

        function formatDate(date) {
            return date.toISOString().slice(0, 19) + 'Z';
        }

        function handleTimeRangeChange() {
            const range = document.getElementById('timeRange').value;
            const customInputs = document.getElementById('customTimeInputs');
            if (range === 'custom') {
                customInputs.classList.remove('hidden');
                customInputs.classList.add('flex');
            } else {
                customInputs.classList.add('hidden');
                customInputs.classList.remove('flex');
                refreshData();
            }
        }

        function calculateTimeRange() {
            const range = document.getElementById('timeRange').value;
            const now = new Date();
            let endTime = new Date(now);
            let startTime;

            switch(range) {
                
                case '3h': startTime = new Date(now.getTime() - 3 * 60 * 60 * 1000); break;
                case '6h': startTime = new Date(now.getTime() - 6 * 60 * 60 * 1000); break;
                case 'today': 
                    startTime = new Date(now);
                    startTime.setHours(0, 0, 0, 0);
                    break;
                case 'yesterday':
                    startTime = new Date(now);
                    startTime.setDate(now.getDate() - 1);
                    startTime.setHours(0, 0, 0, 0);
                    
                    endTime = new Date(now);
                    endTime.setDate(now.getDate() - 1);
                    endTime.setHours(23, 59, 59, 999);
                    break;
                case '3d': startTime = new Date(now.getTime() - 3 * 24 * 60 * 60 * 1000); break;
                case '7d': startTime = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000); break;
                case '14d': startTime = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000); break;
                case '31d': startTime = new Date(now.getTime() - 31 * 24 * 60 * 60 * 1000); break;
                case '182d': startTime = new Date(now.getTime() - 182 * 24 * 60 * 60 * 1000); break;
                case '365d': startTime = new Date(now.getTime() - 364 * 24 * 60 * 60 * 1000); break;
                case 'custom':
                    const days = parseInt(document.getElementById('customDays').value) || 0;
                    const hours = parseInt(document.getElementById('customHours').value) || 0;
                    const minutes = parseInt(document.getElementById('customMinutes').value) || 0;
                    const seconds = parseInt(document.getElementById('customSeconds').value) || 0;
                    
                    let totalMs = ((days * 24 * 60 * 60) + (hours * 60 * 60) + (minutes * 60) + seconds) * 1000;
                    const maxMs = 31 * 24 * 60 * 60 * 1000; // 31 days limit
                    const errorEl = document.getElementById('timeRangeError');

                    if (totalMs > maxMs) {
                        if (errorEl) errorEl.innerText = 'è‡ªå®šä¹‰æ—¶é—´èŒƒå›´ä¸èƒ½è¶…è¿‡ 31 å¤©ï¼Œå·²è‡ªåŠ¨ä¸ºæ‚¨è°ƒæ•´ä¸º 31 å¤©ã€‚';
                        totalMs = maxMs;
                    } else {
                        if (errorEl) errorEl.innerText = '';
                    }

                    if (totalMs > 0) {
                        startTime = new Date(now.getTime() - totalMs);
                    } else {
                        // Default to 1 hour if nothing entered
                        startTime = new Date(now.getTime() - 60 * 60 * 1000);
                    }
                    break;
                default: startTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            }

            return {
                startTime: formatDate(startTime),
                endTime: formatDate(endTime)
            };
        }

        function renderGrowth(elementId, currentVal, prevVal, inverse = false) {
            const el = document.getElementById(elementId);
            if (!el) return;

            let growthEl = document.getElementById(elementId + '_growth');
            if (!growthEl) {
                growthEl = document.createElement('span');
                growthEl.id = elementId + '_growth';
                el.appendChild(growthEl);
            }

            if (prevVal === 0) {
                growthEl.innerText = ''; 
                return;
            }

            const growth = ((currentVal - prevVal) / prevVal) * 100;
            const absGrowth = Math.abs(growth).toFixed(2);
            
            let colorClass = 'text-gray-500';
            let icon = '';
            
            if (growth > 0) {
                icon = 'â†‘';
                colorClass = 'text-red-500';
            } else if (growth < 0) {
                icon = 'â†“';
                colorClass = 'text-green-500';
            } else {
                icon = '-';
            }

            growthEl.className = `text-sm font-normal ml-2 ${colorClass}`;
            growthEl.innerText = `${icon} ${absGrowth}%`;
        }

        async function fetchData(metric, customStart, customEnd, signal) { 
            try {
                let startTime, endTime;
                if (customStart && customEnd) {
                    startTime = customStart;
                    endTime = customEnd;
                } else {
                    const range = calculateTimeRange();
                    startTime = range.startTime;
                    endTime = range.endTime;
                }

                const interval = document.getElementById('interval').value;
                const zoneId = '';
                
                let url = `/cf/traffic?metric=${metric}&startTime=${encodeURIComponent(startTime)}&endTime=${encodeURIComponent(endTime)}`;
                if (interval && interval !== 'auto') {
                    url += `&interval=${interval}`;
                }
                
                // å°† signal ä¼ å…¥ fetch
                const response = await fetch(url, { signal }); 
                const result = await response.json();
                if (result.error) throw new Error(result.error);
                return result;
            } catch (err) {
                // å¦‚æœæ˜¯ä¸»åŠ¨å–æ¶ˆçš„ï¼Œä¸æ‰“å°é”™è¯¯æ—¥å¿—
                if (err.name === 'AbortError') {
                    console.log(`Fetch aborted for metric: ${metric}`);
                    return null;
                }
                console.error(`Error fetching ${metric}:`, err);
                return null;
            }
        }

        function processData(result, targetMetric) {
            // Check for Top Data Structure (DescribeTopL7AnalysisData)
            if (result?.Data?.[0]?.DetailData) {
                 return {
                     type: 'top',
                     data: result.Data[0].DetailData
                 };
            }

            // DescribeTimingL7AnalysisData returns 'Data'
            const dataList = result?.Data || result?.TimingDataRecords || [];
            if (dataList.length === 0) return { timeData: [], valueData: [], sum: 0, max: 0, avg: 0, type: 'time' };

            let typeValue;
            
            // Try to find matching metric in TypeValue or Value
            if (targetMetric) {
                if (dataList[0]?.TypeValue) {
                    typeValue = dataList[0].TypeValue.find(item => item.MetricName === targetMetric);
                } else if (dataList[0]?.Value) {
                    typeValue = dataList[0].Value.find(item => item.MetricName === targetMetric);
                }
            }

            // Fallback if not found or no targetMetric (or if only one exists)
            if (!typeValue) {
                 typeValue = dataList[0]?.TypeValue?.[0];
                 // Support DescribeWebProtectionData structure (Value instead of TypeValue)
                 if (!typeValue && dataList[0]?.Value?.[0]) {
                    typeValue = dataList[0].Value[0];
                 }
            }

            const details = typeValue?.Detail || [];
            const sum = typeValue?.Sum || 0;
            const max = typeValue?.Max || 0;
            const avg = typeValue?.Avg || 0;

            const timeData = [];
            const valueData = [];

            // Context for formatting
            const range = document.getElementById('timeRange')?.value || '30min';
            const interval = document.getElementById('interval')?.value || 'auto';
            const longRanges = ['3d', '7d', '14d', '31d'];
            
            // Auto-detect if interval is effectively 'day'
            let isDayInterval = interval === 'day';
            if (interval === 'auto' && details.length > 1) {
                const diff = details[1].Timestamp - details[0].Timestamp;
                // If interval is >= 23 hours (allow some slack), treat as day
                if (diff >= 82800) isDayInterval = true;
            }
            // If auto and range is 31d/15d, it usually defaults to day
            if (interval === 'auto' && ['14d', '31d'].includes(range)) {
                // Check if we have few points (e.g. < 32 for 31d), likely day
                if (details.length <= 32) isDayInterval = true;
            }

            // Calculate time span of the data
            let span = 0;
            if (details.length > 0) {
                 span = details[details.length - 1].Timestamp - details[0].Timestamp;
            }

            details.forEach(item => {
                const date = new Date(item.Timestamp * 1000);
                let label;

                if (isDayInterval) {
                    // Show YYYY-MM-DD
                    label = `${date.getFullYear()}-${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                } else if (span > 86400 || longRanges.includes(range) || (range === 'custom' && span > 86400)) {
                    // Show MM-DD HH:mm for long ranges or custom > 24h
                    label = `${(date.getMonth()+1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                } else {
                    // Show HH:mm for short ranges
                    label = `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
                }

                timeData.push(label);
                valueData.push(item.Value);
            });

            return { timeData, valueData, sum, max, avg, type: 'time' };
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1000;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            if (i < 0) return bytes + ' B';
            if (i >= sizes.length) return (bytes / Math.pow(k, sizes.length - 1)).toFixed(2) + ' ' + sizes[sizes.length - 1];
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatCount(num) {
            if (num === 0) return '0 æ¬¡';
            if (num < 1000) return num.toString()+ ' æ¬¡';
            if (num < 10000) return (num / 1000).toFixed(2) + ' åƒ';
            if (num < 100000000) return (num / 10000).toFixed(2) + ' ä¸‡';
            return (num / 100000000).toFixed(2) + ' äº¿';
        }

        function getBestCountUnit(maxValue) {
            if (maxValue < 1000) return { unit: 'æ¬¡', divisor: 1 };
            if (maxValue < 10000) return { unit: 'åƒæ¬¡', divisor: 1000 };
            if (maxValue < 100000000) return { unit: 'ä¸‡æ¬¡', divisor: 10000 };
            return { unit: 'äº¿æ¬¡', divisor: 100000000 };
        }

        function getBestUnit(maxValue, type = 'bytes') {
            const k = 1000;
            const byteUnits = ['B', 'KB', 'MB', 'GB', 'TB', 'PB'];
            const bitUnits = ['bps', 'Kbps', 'Mbps', 'Gbps', 'Tbps', 'Pbps'];
            const units = type === 'bandwidth' ? bitUnits : byteUnits;

            if (maxValue === 0) return { unit: units[0], divisor: 1 };

            let i = Math.floor(Math.log(maxValue) / Math.log(k));
            if (i < 0) i = 0;
            if (i >= units.length) i = units.length - 1;

            return { unit: units[i], divisor: Math.pow(k, i) };
        }

        /** Feature Functions **/

        ////ENTRANCE////
        async function initDashboard() {
            chartTraffic = echarts.init(document.getElementById('chart_traffic'));
            chartRequests = echarts.init(document.getElementById('chart_requests'));
            
            // Map
            chartTopMap = echarts.init(document.getElementById('chart_top_map'));
            
            // Flux Charts
            chartTopCountry = echarts.init(document.getElementById('chart_top_country'));     
            chartTopDomain = echarts.init(document.getElementById('chart_top_domain'));
            chartTopResourceType = echarts.init(document.getElementById('chart_top_resource_type'));
			chartTopRequestSip = echarts.init(document.getElementById('chart_top_request_sip'));
            chartTopRequestzym = echarts.init(document.getElementById('chart_top_request_zym'));
            // Request Charts
            chartTopRequestCountry = echarts.init(document.getElementById('chart_top_request_country'));
            chartTopRequestDomain = echarts.init(document.getElementById('chart_top_request_domain'));
            chartTopRequestResourceType = echarts.init(document.getElementById('chart_top_request_resource_type'));
            chartFunctionRequests = echarts.init(document.getElementById('chart_function_requests'));
            chartFunctionCpu = echarts.init(document.getElementById('chart_function_cpu'));
            
			await refreshData();
        }

        async function refreshData() {
            // 1. ä¸­æ–­ä¹‹å‰çš„è¯·æ±‚ï¼Œé˜²æ­¢å¿«é€Ÿåˆ‡æ¢å¯¼è‡´çš„æ•°æ®å†²çª
            if (currentAbortController) {
                currentAbortController.abort();
            }
            currentAbortController = new AbortController();
            const signal = currentAbortController.signal;

            // 2. å‡†å¤‡æŒ‡æ ‡åˆ—è¡¨
            const rawMetrics = [
                ...metricsConfig.traffic,
                ...metricsConfig.requests,
                ...metricsConfig.topAnalysis,
				...metricsConfig.edgeFunctions
            ];
            const uniqueMetrics = [...new Set(rawMetrics)];

            // 3. åˆå§‹åŒ– UI çŠ¶æ€
            document.querySelectorAll('[id^="kpi_"]').forEach(el => {
                if (!el.id.includes('growth')) el.innerText = 'åŠ è½½ä¸­...';
            });

            const progressBar = document.getElementById('loading-progress-bar-2'); // Fixed ID to avoid conflict if running in same environment
            if (progressBar) {
                progressBar.style.width = '0%';
                progressBar.classList.remove('bg-red-500');
                progressBar.classList.add('bg-blue-500');
                progressBar.parentElement.classList.remove('opacity-0');
            }

            const { startTime, endTime } = calculateTimeRange();
            const totalTasks = uniqueMetrics.length;
            let completedTasks = 0;
            const results = {}; // ç”¨äºå­˜å‚¨æ‰€æœ‰è¯·æ±‚ç»“æœ

            // æ˜ å°„ Section æ›´æ–°å‡½æ•°
            const updateMap = {
                'traffic': updateTrafficSection,
                'requests': updateRequestsSection,
				'edgeFunctions': updateEdgeFunctionsSection,
                'topAnalysis': updateTopAnalysisSection
            };

            const getSection = (metric) => {
                for (const [section, metrics] of Object.entries(metricsConfig)) {
                    if (metrics.includes(metric)) return section;
                }
                return null;
            };

            // 4. å¹¶è¡Œå‘èµ·æ‰€æœ‰è¯·æ±‚
            const fetchPromises = uniqueMetrics.map(async (metric) => {
                // å¦‚æœæ•´ä½“è¢«ä¸­æ–­ï¼Œç›´æ¥è¿”å›
                if (signal.aborted) return;

                try {
                    // å‘èµ·è¯·æ±‚
                    const res = await fetchData(metric, startTime, endTime, signal);

                    // è¯·æ±‚å›æ¥åå†æ¬¡æ£€æŸ¥ä¸­æ–­
                    if (signal.aborted) return;

                    if (res) {
                        // å¤„ç†æ•°æ®å¹¶å­˜å…¥ results å¯¹è±¡
                        results[metric] = processData(res, metric);
                        
                        // ç«‹å³æ›´æ–°å¯¹åº”çš„ UI æ¨¡å— (å®ç°å¢é‡æ¸²æŸ“)
                        const section = getSection(metric);
                        if (section && updateMap[section]) {
                            updateMap[section](results);
                        }
                    }
                } catch (error) {
                    // å¿½ç•¥ AbortErrorï¼Œæ‰“å°å…¶ä»–é”™è¯¯
                    if (error.name !== 'AbortError') {
                        console.error(`è¯·æ±‚å¤±è´¥: ${metric}`, error);
                        if (progressBar) progressBar.classList.add('bg-red-500');
                    }
                } finally {
                    // æ— è®ºæˆåŠŸå¤±è´¥ï¼Œæ›´æ–°è¿›åº¦æ¡
                    if (!signal.aborted) {
                        completedTasks++;
                        const percentage = (completedTasks / totalTasks) * 100;
                        if (progressBar) progressBar.style.width = `${percentage}%`;
                    }
                }
            });

            // 5. ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ (Promise.all ä¼šå¹¶è¡Œæ‰§è¡Œ)
            await Promise.all(fetchPromises);
			lastResults = results;
            // 6. éšè—è¿›åº¦æ¡
            setTimeout(() => {
                if (progressBar && !signal.aborted) progressBar.parentElement.classList.add('opacity-0');
            }, 500);
        }

        function updateTrafficSection(results) {
            const metrics = metricsConfig.traffic;
            const series = [];
            let timeData = [];

            // Calculate global max
            let globalMax = 0;
            metrics.forEach(metric => {
                const data = results[metric];
                if (data && data.type === 'time') {
                    const max = Math.max(...data.valueData);
                    if (max > globalMax) globalMax = max;
                }
            });

            const { unit, divisor } = getBestUnit(globalMax, 'bytes');

            metrics.forEach(metric => {
                const data = results[metric];
                if (!data || data.type !== 'time') return;
                
                // Update KPI
                if (metric === 'l7Flow_inFlux'|| metric === 'l7Flow_cachedRequests') {
                    document.getElementById(`kpi_${metric}`).innerText = formatCount(data.sum);
                } else {
                    document.getElementById(`kpi_${metric}`).innerText = formatBytes(data.sum);
                }

                if (timeData.length === 0) timeData = data.timeData;

                // Chart Data (Dynamic Unit)
                const valueData = data.valueData.map(v => (v / divisor).toFixed(2));
                
                series.push({
                    name: metricLabels[metric],
                    type: 'line',
                    smooth: true,
                    data: valueData,
                    itemStyle: { color: metricColors[metric] },
                    areaStyle: { opacity: 0.1 },
                    // Store raw data for tooltip
                    rawData: data.valueData
                });
            });

            // é˜²æ­¢æ²¡æœ‰æ•°æ®æ—¶æŠ¥é”™
            if (series.length === 0) return;

            const option = {
                tooltip: { 
                    trigger: 'axis', 
					
                    formatter: (params) => {
                        let res = params[0].axisValue + '<br/>';
                        params.forEach(param => {
                            // --- å®‰å…¨æ ¡éªŒ ---
                            const seriesIndex = param.seriesIndex;
                            const dataIndex = param.dataIndex;
                            const seriesItem = series[seriesIndex];
                            if (!seriesItem || !seriesItem.rawData) return;
                            const rawVal = seriesItem.rawData[dataIndex];
                            if (rawVal === undefined) return;
                            
                            let formattedVal;
                            if (param.seriesName === 'é¡µé¢æµè§ˆé‡' || param.seriesName === 'ç¼“å­˜è¯·æ±‚æ•°') {
                                formattedVal = formatCount(rawVal);
                            } else {
                                formattedVal = formatBytes(rawVal);
                            }
                            res += `${param.marker}${param.seriesName}: ${formattedVal}<br/>`;
                        });
                        return res;
                    }
                },
                legend: {
  data: metrics.map(m => metricLabels[m]),
  bottom: 0,
  icon: 'circle',
  formatter: function (name) {
    // æ ¹æ® label åæŸ¥ metric key
    const metric = Object.keys(metricLabels)
      .find(k => metricLabels[k] === name);

    return `{${metric}|${name}}`;
  },

  textStyle: {
    
    rich: {
      l7Flow_flux: {
        color: metricColors.l7Flow_flux,
        fontWeight: 500
      },
      l7Flow_outFlux: {
        color: metricColors.l7Flow_outFlux,
        fontWeight: 500
      },
      l7Flow_cachedRequests: {
        color: metricColors.l7Flow_cachedRequests,
        fontWeight: 500
      }
    }
  }
},

                grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                xAxis: { type: 'category', boundaryGap: false, data: timeData },
                yAxis: { type: 'value', name: unit },
                series: series
            };
            
            // Ensure chartTraffic is initialized and disposed safely if needed
            if (chartTraffic && chartTraffic.clear) {
                updateCacheHitRate(results);
                // é‡è¦ï¼šç¬¬äºŒä¸ªå‚æ•° true è¡¨ç¤ºä¸åˆå¹¶ (notMerge)ï¼Œæ¸…é™¤æ—§çŠ¶æ€
                chartTraffic.setOption(option, true);
            }
        }
		
		function updateCacheHitRate(results) {
    const hitRateEl = document.getElementById('kpi_cache_hit_rate');
    if (!hitRateEl) return;

    const cached = results['l7Flow_cachedRequests']?.sum;
    const total = results['l7Flow_request']?.sum;

    if (typeof cached !== 'number' || typeof total !== 'number' || total <= 0) {
        hitRateEl.innerText = 'åŠ è½½ä¸­...';
        return;
    }

    const ratio = cached / total;
    hitRateEl.innerText = (ratio * 100).toFixed(2) + ' %';
}


        function updateRequestsSection(results) {
            const metrics = metricsConfig.requests;
            const series = [];
            let timeData = [];

            // Calculate global max
            let globalMax = 0;
            metrics.forEach(metric => {
                const data = results[metric];
                if (data && data.type === 'time') {
                    const max = Math.max(...data.valueData);
                    if (max > globalMax) globalMax = max;
                }
            });

            const { unit, divisor } = getBestCountUnit(globalMax);

            metrics.forEach(metric => {
                const data = results[metric];
                if (!data || data.type !== 'time') return;
                
                // Update KPI
                document.getElementById(`kpi_${metric}`).innerText = formatCount(data.sum);

                // Growth
                const prevData = results[metric + '_prev'];
                if (prevData) {
                    renderGrowth(`kpi_${metric}`, data.sum, prevData.sum);
                }

                if (timeData.length === 0) timeData = data.timeData;

                // Chart Data (Dynamic Unit)
                const valueData = data.valueData.map(v => {
                    const val = v / divisor;
                    return (divisor === 1) ? val : val.toFixed(2);
                });

                series.push({
                    name: metricLabels[metric],
                    type: 'line',
                    smooth: true,
                    data: valueData,
                    itemStyle: { color: metricColors[metric] },
                    areaStyle: { opacity: 0.2 },
                    rawData: data.valueData
                });
            });

            if (series.length === 0) return;

            const option = {
                tooltip: { 
                    trigger: 'axis', 
                    formatter: (params) => {
                        let res = params[0].axisValue + '<br/>';
                        params.forEach(param => {
                             // --- å®‰å…¨æ ¡éªŒ ---
                            const seriesIndex = param.seriesIndex;
                            const dataIndex = param.dataIndex;
                            const seriesItem = series[seriesIndex];
                            if (!seriesItem || !seriesItem.rawData) return;
                            const rawVal = seriesItem.rawData[dataIndex];
                            if (rawVal === undefined) return;
                            
                            const formattedVal = formatCount(rawVal);
                            res += `${param.marker}${param.seriesName}: ${formattedVal}<br/>`;
                        });
                        return res;
                    }
                },
				
				legend: {
  data: metrics.map(m => metricLabels[m]),
  bottom: 0,
  icon: 'circle',
  formatter: function (name) {
    // æ ¹æ® label åæŸ¥ metric key
    const metric = Object.keys(metricLabels)
      .find(k => metricLabels[k] === name);

    return `{${metric}|${name}}`;
  },

  textStyle: {
    
    rich: {
      l7Flow_request: {
        color: metricColors.l7Flow_request,
        fontWeight: 500
      },
      l7Flow_outcc: {
        color: metricColors.l7Flow_outcc,
        fontWeight: 500
      },
      l7Flow_inFlux: {
        color: metricColors.l7Flow_inFlux,
        fontWeight: 500
      }
    }
  }
},
                grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                xAxis: { type: 'category', boundaryGap: false, data: timeData },
                yAxis: { type: 'value', name: unit },
                series: series
            };
            
            if (chartRequests) {
               updateCacheHitRate(results);
               chartRequests.setOption(option, true);
            }
        }
		
		function updateEdgeFunctionsSection(results) {
            const metrics = metricsConfig.edgeFunctions;
            
            // Map metrics to specific charts and KPIs
            const metricMap = {
                'function_requestCount': {
                    chart: chartFunctionRequests,
                    kpiId: 'kpi_function_requestCount',
                    unitType: 'count',
                    color: metricColors['function_requestCount']
                },
                'function_cpuCostTime': {
                    chart: chartFunctionCpu,
                    kpiId: 'kpi_function_cpuCostTime',
                    unitType: 'ms',
                    color: metricColors['function_cpuCostTime']
                }
            };

            metrics.forEach(metric => {
                const config = metricMap[metric];
                if (!config) return;

                const data = results[metric];
                if (!data || data.type !== 'time') return;

                // Update KPI
                const kpiEl = document.getElementById(config.kpiId);
                if (kpiEl) {
                    if (config.unitType === 'count') {
                        kpiEl.innerText = formatCount(data.sum);
                    } else if (config.unitType === 'ms') {
                        // Format large numbers with commas
                        kpiEl.innerText = data.sum.toLocaleString() + ' ms';
                    }

                    // Growth
                    const prevData = results[metric + '_prev'];
                    if (prevData) {
                        const curVal = data.sum;
                        const preVal = prevData.sum;
                        renderGrowth(config.kpiId, curVal, preVal, config.unitType === 'ms');
                    }
                }

                // Chart
                const chart = config.chart;
                if (!chart) return;

                let seriesData = data.valueData;
                let unit = '';
                let divisor = 1;

                if (config.unitType === 'count') {
                     const best = getBestCountUnit(Math.max(...data.valueData));
                     unit = best.unit;
                     divisor = best.divisor;
                     seriesData = data.valueData.map(v => {
                        const val = v / divisor;
                        return (divisor === 1) ? val : val.toFixed(2);
                     });
                } else if (config.unitType === 'ms') {
                     unit = 'ms';
                }

                const option = {
                    tooltip: { trigger: 'axis', formatter: (params) => {
                        let res = params[0].axisValue + '<br/>';
                        params.forEach(param => {
                            const val = data.valueData[param.dataIndex];
                            let formattedVal = val;
                            if (config.unitType === 'count') formattedVal = formatCount(val);
                            else formattedVal = val.toLocaleString() + ' ms';
                            
                            res += `${param.marker}${param.seriesName}: ${formattedVal}<br/>`;
                        });
                        return res;
                    }},
					
					
                    legend: {
  data: metrics.map(m => metricLabels[m]),
  bottom: 0,
  icon: 'circle',
  formatter: function (name) {
    const metric = Object.keys(metricLabels)
      .find(k => metricLabels[k] === name);

    return `{${metric}|${name}}`;
  },

  textStyle: {
    
    rich: {
      function_requestCount: {
        color: metricColors.function_requestCount,
        fontWeight: 500
      },
      function_cpuCostTime: {
        color: metricColors.function_cpuCostTime,
        fontWeight: 500
      }      
    }
  }
},

                    grid: { left: '3%', right: '4%', bottom: '10%', top: '15%', containLabel: true },
                    xAxis: { type: 'category', boundaryGap: false, data: data.timeData },
                    yAxis: { type: 'value', name: unit },
                    series: [{
                        name: metricLabels[metric],
                        type: 'line',
                        smooth: true,
                        data: seriesData,
                        itemStyle: { color: config.color },
                        areaStyle: { opacity: 0.1 }
                    }]
                };
                chart.setOption(option,true);
            });
        }

        //é€šç”¨å¤„ç†
        const renderTopChart = (results, chartInstance, metricName, mapObject = null) => {
            const data = results[metricName];
			const isDark = document.documentElement.classList.contains('dark');

            if (!data || data.type !== 'top' || !data.data) return;

            const sortedData = [...data.data].sort((a, b) => b.Value - a.Value).slice(0, 10);
            
            let unit = '';
            let divisor = 1;
            let label = metricLabels[metricName] || '';
            
            if (metricName.includes('outFlux')) {
                const maxVal = sortedData.length > 0 ? sortedData[0].Value : 0;
                const best = getBestUnit(maxVal, 'bytes');
                unit = best.unit;
                divisor = best.divisor;
            } else {
                const maxVal = sortedData.length > 0 ? sortedData[0].Value : 0;
                const best = getBestCountUnit(maxVal);
                unit = best.unit;
                divisor = best.divisor;
            }

            const yAxisData = sortedData.map(item => mapObject?.[item.Key] || item.Key).reverse();
            const seriesData = sortedData.map(item => {
                const val = item.Value / divisor;
                return (divisor === 1) ? val : val.toFixed(2);
            }).reverse();

            let color = '#3b82f6';
            const lowerName = metricName.toLowerCase();
            if (lowerName.includes('country')) color = '#3b82f6';
            else if (lowerName.includes('province') || lowerName.includes('resourcetype') || lowerName.includes('browser')) color = '#f59e0b';
            else if (lowerName.includes('statuscode') || lowerName.includes('referer') || lowerName.endsWith('_ua')) color = '#8b5cf6';
            else if (lowerName.includes('domain') || lowerName.includes('device')) color = '#06b6d4';
            else if (lowerName.includes('url') || lowerName.includes('os')) color = '#10b981';
            else if (lowerName.includes('sip')) color = '#ef4444';

            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: { type: 'shadow' },
                    formatter: (params) => {
                         const param = params[0];
                         let name = param.name;
                         if (name.length > 100) name = name.substring(0, 100) + '...';
                         
                         const rawVal = sortedData[sortedData.length - 1 - param.dataIndex].Value;
                         
                         let formattedVal = '';
                         if (metricName.includes('outFlux')) {
                             formattedVal = formatBytes(rawVal);
                         } else {
                             const fVal = formatCount(rawVal);
                             formattedVal = fVal; 
                         }
                         
                         return `${name}<br/>${param.marker}${label}: ${formattedVal}`;
                    }
                },
                grid: { left: '3%', right: '10%', bottom: '3%', containLabel: true },
                xAxis: { type: 'value', name: unit },
                yAxis: { 
  type: 'category', 
  data: yAxisData,
  axisLabel: {
    color: isDark ? '#e5e7eb' : '#6E7079',
    fontWeight: 500,
    formatter: function (value) {
      if (value.length > 20) return value.substring(0, 20) + '...';
      return value;
    }
  }
},
                series: [
  {
    name: label,
    type: 'bar',
    data: seriesData,
    itemStyle: { color: color },
    label: {
      show: true,
      position: 'right',
      backgroundColor: 'transparent',
      padding: 0,
      color: isDark ? '#e5e7eb' : '#111827',
	  fontWeight: 500
    }
  }
]
            };
            chartInstance.setOption(option);
        };

        function updateTopMapChart(results) {
            const metric = 'l7Flow_request_country';
            const data = results[metric];

            if (!data || data.type !== 'top' || !data.data) return;

            const mapData = data.data.map(item => {
                const name = countryMap[item.Key] || codeToMapName[item.Key] || item.Key;
                return {
                    name: name,
                    value: item.Value
                };
            });

            const maxVal = mapData.length > 0 ? Math.max(...mapData.map(item => item.value)) : 0;

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function (params) {
                        const val = params.value;
                        return `${params.name}<br/>è¯·æ±‚æ•°: ${val ? val.toLocaleString() : 0} æ¬¡`;
                    }
                },
                visualMap: {
                    min: 0,
                    max: maxVal,
                    left: 'left',
                    top: 'bottom',
                    text: ['High', 'Low'],
                    calculable: true,
                    inRange: {
                        color: ['#e0f2fe', '#0284c7']
                    }
                },
                series: [
                    {
                        name: 'è¯·æ±‚æ•°',
                        type: 'map',
                        mapType: 'world',
                        roam: true,
                        nameMap: worldNameMap,
                        itemStyle: {
                            emphasis: { label: { show: true } }
                        },
                        data: mapData
                    }
                ]
            };
			
            chartTopMap.setOption(option,true);
        }

        function updateTopAnalysisSection(results) {
            updateTopMapChart(results);
            renderTopChart(results, chartTopCountry, 'l7Flow_outFlux_country', countryMap);
            renderTopChart(results, chartTopDomain, 'l7Flow_outFlux_domain');
            renderTopChart(results, chartTopResourceType, 'l7Flow_outFlux_resourceType');
            renderTopChart(results, chartTopRequestCountry, 'l7Flow_request_country', countryMap);
            renderTopChart(results, chartTopRequestDomain, 'l7Flow_request_domain');
            renderTopChart(results, chartTopRequestResourceType, 'l7Flow_request_resourceType');
			renderTopChart(results, chartTopRequestSip, 'l7Flow_request_sip');
			renderTopChart(results, chartTopRequestzym, 'l7Flow_request_zym');
        }

        // Handle Resize
        window.addEventListener('resize', () => {
            chartTraffic && chartTraffic.resize();
            chartRequests && chartRequests.resize();
            
            chartTopMap && chartTopMap.resize();
            
            chartTopCountry && chartTopCountry.resize();
            chartTopDomain && chartTopDomain.resize();
            chartTopResourceType && chartTopResourceType.resize();
            
            chartTopRequestCountry && chartTopRequestCountry.resize();
            chartTopRequestDomain && chartTopRequestDomain.resize();
            chartTopRequestResourceType && chartTopRequestResourceType.resize();
			chartTopRequestSip && chartTopRequestSip.resize();
			chartTopRequestzym && chartTopRequestzym.resize();
			chartFunctionRequests && chartFunctionRequests.resize();
            chartFunctionCpu && chartFunctionCpu.resize();
        });

        // Start - Entrance
        initDashboard();
		
        // ğŸŒ™ å¤œé—´æ¨¡å¼é€»è¾‘
        function applyTheme(theme) {
            const html = document.documentElement;
            const btn = document.getElementById('themeToggle');

            // å®šä¹‰ SVG å›¾æ ‡å˜é‡ï¼Œæ·»åŠ  class="w-4 h-4 mr-2" ä»¥ä¾¿ä¸æ–‡å­—å¯¹é½
            // å¤ªé˜³å›¾æ ‡ (åˆ‡æ¢åˆ°æ—¥é—´æ¨¡å¼)
            const sunIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sun h-4 w-4"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>';
            
            
            const moonIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-moon h-4 w-4"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>';

            if (theme === 'dark') {
                html.classList.add('dark');
                // å¤œé—´æ¨¡å¼ä¸‹ï¼šæ˜¾ç¤ºå¤ªé˜³å›¾æ ‡ï¼Œç‚¹å‡»åˆ‡æ¢åˆ°æ—¥é—´æ¨¡å¼
                btn.innerHTML = `${sunIcon}`;
            } else {
                html.classList.remove('dark');
                // æ—¥é—´æ¨¡å¼ä¸‹ï¼šæ˜¾ç¤ºæœˆäº®å›¾æ ‡ï¼Œç‚¹å‡»åˆ‡æ¢åˆ°å¤œé—´æ¨¡å¼
                btn.innerHTML = `${moonIcon}`;
            }

            localStorage.setItem('theme', theme);

            // åˆ·æ–° ECharts ä¸»é¢˜ï¼ˆæˆ–é‡ç»˜å›¾è¡¨ä»¥é€‚åº”æ·±è‰²èƒŒæ™¯å˜åŒ–ï¼‰
            setTimeout(() => {
               rerenderChartsByTheme();
            }, 50);
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.contains('dark');
            applyTheme(isDark ? 'light' : 'dark');
        }
		// åˆå§‹åŒ–ä¸»é¢˜
        (function initTheme() {
            const saved = localStorage.getItem('theme');
            if (saved) {
                applyTheme(saved);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                applyTheme('dark');
            }
        })();
        function rerenderChartsByTheme() {
          if (!lastResults) return;
          updateTrafficSection(lastResults);
          updateRequestsSection(lastResults);
          updateEdgeFunctionsSection(lastResults);
          updateTopAnalysisSection(lastResults);
        }
    </script>
</body>
</html>